<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name = "format-detection" content = "telephone=no"/>
  <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
  <link rel="stylesheet" href="css/jquery.mobile-1.4.5.css">
  <link rel="stylesheet" type="text/css" href="css/index.css" />
  <!--script type="text/javascript" src="cordova.js"></script-->
  <script src="js/Tocca.min.js"></script>
  <title>Electronic Copyboard</title>

  <script src="js/jquery.js"></script>

  <script>
    // Bind to "mobileinit" before you load jquery.mobile.js
    $(document).on( "mobileinit", function()
    {
      //$.mobile.defaultPageTransition = "slide";
      $.mobile.listview.prototype.options.headerTheme = "b";
      // Prevent problems with the JQM popups
      $.mobile.popup.prototype.options.history = false;
    });

    pollTimer = 0;
  </script>

  <script src="js/jquery.mobile-1.4.5.js"></script>

  <script>
    $(function()
    {
      $(document).pagecontainer({defaults: true});
      $("[data-role=header]").toolbar(); /* initialize header */

      // Navigate to next page when the "next" button is clicked
      $(".control .next").on("click", function()
      {
        //console.log("nextbtn, "+ prev + " <> " + next);
        if(next)
          $("body").pagecontainer("change", next);
        else
          app.splashshow();
      });
      $(".control .prev").on("click", function()
      {
        console.log("prevbtn, "+ prev + " <> " + next);
        $("body").pagecontainer("change", prev, {reverse: true});
      });
    });

    $(document).on("pagecontainerbeforetransition", function( event, ui )
    {
      // Get the references to the prev and next page that we stored in the data-next attribute
      next = ui.toPage.jqmData("next");
      prev = ui.toPage.jqmData("prev");

      console.log("pagecontainerchange, "+ prev + " <> " + next);
      if(next)
        $(".control .next").removeClass("ui-disabled");
      else
        $(".control .next").addClass("ui-disabled");

      if(prev)
        $(".control .prev").removeClass("ui-disabled");
      else
        $(".control .prev").addClass("ui-disabled");
        
      $("#title").html(ui.toPage.jqmData("title"));
      
      //app.setStatus("");
    });

    // Navigate to next page on swipe left
    $(document).on("swipeleft", $(document), function()
    {
      if(next)
      {
        //console.log("swipe, "+ prev + " <> " + next);
        //$("body").pagecontainer("change", next);
      }
    });
    $(document).on("swiperight", $(document), function()
    {
      if(prev)
      {
        //console.log("swipe, "+ prev + " <> " + next);
        //$("body").pagecontainer("change", prev, {reverse: true});
      }
    });

    // Take over the device back button
    $(window).on("navigate", function (event, data)
    {
      var direction = data.state.direction;
      if (direction == 'back')
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "content")
        {
          if(vBleId)
          {
            ble.close(vBleId);
            vBleId = "";
          }          
          app.disconnect(true);
          navigator.app.exitApp();	// Android only
        }
        else
        {
          $("body").pagecontainer("change", "#content", {transition:"fade"});
        }
      }
      return(false);
    });

    $.fn.redraw = function()
    {
      return $(this).each(function()
      {
        var redraw = this.offsetHeight;
      });
    };
  </script>

  <script type="text/javascript" src="cordova.js"></script>
  <script type="text/javascript" src="js/index.js"></script>

  <style>
    /* Prevent text selection while swiping with mouse */
    .ui-header, .ui-title, .trivia-btn
    {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      -o-user-select: none;
      user-select: none;
    }
  </style>
</head>
<body style="background-color: #252525;">


<div data-role="header" id="header" style="overflow:hidden;" class="ui-page-theme-a" data-position="fixed" data-tap-toggle="false">
  <h1 id="title">Electronic Copyboard</h1>
  
  <table class="control ui-btn-left"><tr><td>
    <a id="LocalOpen" href="#LocalOpenPopup" class="ui-icon-library ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" data-rel="popup">Load from local</a>
    <a id="LocalSave" href="#LocalSavePopup" class="ui-icon-heart ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" data-rel="popup">Save local</a>
  </td></tr></table>

  <table class="control ui-btn-right"><tr><td>
    <a id="DisplaySave" href="#" class="ui-icon-check ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="BluetoothSave();">Save to display</a>
    <a id="DisplayConnect" href="#BluetoothConnectPopup" class="ui-icon-clock ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" data-rel="popup">Connect to display</a>
    <a id="SysInfo" href="#SystemInfoPopup" class="ui-icon-info ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" data-rel="popup">System info</a>
  </td></tr></table>

  <div data-role="popup" id="LocalSavePopup" data-theme="a" data-position-to="window" data-transition="pop" data-dismissible='false' class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Save display configuration</h3>
      <p>TODO Set filename and dump data to local storage</p>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancel</a>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow" onclick="LocalSaveExec();">Done</a>
    </div>
  </div>
  <script>
    LocalSaveExec = function()
    {
      console.log('Saving');
    }
  </script>

  <div data-role="popup" id="LocalOpenPopup" data-theme="a" data-position-to="window" data-transition="pop" data-dismissible='false' class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Load display configuration</h3>
      <p>TODO List files available in local storage</p>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancel</a>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow" onclick="LocalOpenExec();">Done</a>
    </div>
  </div>
  <script>
    LocalOpenExec = function()
    {
      console.log('Opening');
    }
  </script>

  <div data-role="popup" id="BluetoothConnectPopup" data-theme="a" data-position-to="window" data-transition="pop" data-dismissible='false' class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Bluetooth connect</h3>
      <p>Scanning BLE devices in range</p>
      <p><span id="ble-id">.</span></p>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" onclick="BluetoothConnectAbort();">Cancel</a>
      <a href="#" id="BluetoothConnectButton" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b ui-state-disabled" data-transition="flow" onclick="BluetoothConnectExec();">Connect</a>
    </div>
  </div>
  <div data-role="popup" id="BluetoothDownloadPopup" data-theme="a" data-position-to="window" data-transition="pop" data-dismissible='false' class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Download content from display?</h3>
      <p></p>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" onclick="BluetoothConnectAbort();">No</a>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow" onclick="BluetoothConnectExec();">Yes</a>
    </div>
  </div>
  <script>
    const EccbService = "36a0ca50-bb8f-4ce4-b0a3-6c79a49d533f";
    const CharDeviceInfo = "7223adac-65ff-4c32-b76a-51A02de0b828";
    const CharPageChange = "7223adac-65ff-4c32-b76a-31901df0a818";
    const CharacteristicPage = "0d0a4662-2421-4fbd-90ab-a702ff0239b6";
    const CharacteristicText = "ee5d2e57-3490-4c06-956b-5a384b1cbaa4";
    
    var vBleId, vBleName;
    
    var vScreenIndex;
    var vScreenWidth;
    var vScreenHeight;
    
    function BleDeviceInfo(buffer)
    {
      var text = String.fromCharCode.apply(null, new Uint8Array(buffer));
      text = text.split('\n');
      for(var i = 0; i < text.length; i++)
      {
        var t = text[i].split(' ').slice(1).join(' ');
        
        switch(i)
        {
          case 0: $('#hardware').text(t); break;
          case 1: $('#serial').text(t); break;
          case 2: $('#bootloader').text(t); break;
          case 3: $('#firmware').text(t); break;
          case 4: $('#fpgaware').text(t); break;
        }
      }
    }
    
    function BlePageNotified(buffer)
    {
      var data = new Uint8Array(buffer);
      
      // Request full page data
      if(data.length == 10)
      {
        vScreenIndex = data[0] + 1;  // Update page number
        //vScreenCount = data[1];
        
        // Add missing pages
        for(var i = 0; i < vScreenIndex; i++)
          if(typeof(vScreens[i]) !== 'object')
            vScreens[i] = {'name':'', 'effect':'', 'duration':60, 'refresh':6, 'goto':0, 'lines':['', '', '', '', '']};

        // Invalidate non existing pages in local data
        while(vScreens.length > data[1])
          vScreens.pop();
        
        //vScreenCountMax = data[2];
        vScreenWidth = (data[7] & 0x7F) * 256 + data[6];
        vScreenHeight = (data[9] & 0x7F) * 256 + data[8];
        $('#DisplaySize').html(vScreenWidth + "&times;" + vScreenHeight)
      }
      ble.read(vBleId, EccbService, CharacteristicPage, BlePageChanged, BleError);
    }
    
    function BlePageChanged(buffer)
    {
      var data = new Uint8Array(buffer);
      var page, idx;

      if(data.length < 10)
        return;
        
      page = data[0];  // Update page number
      vScreens[page].duration = data[3] * 256 + data[2];
      vScreens[page].refresh = data[5] * 256 + data[4];
      idx = data[9];
      idx = idx * 256 + data[8];
      idx = idx * 256 + data[7];
      idx = idx * 256 + data[6];
      vScreens[page].alarm = idx;
      vScreens[page].goto = data[10];
    
      for (idx = 12; idx < data.length; idx++)
        if(data[idx] == 0)
          break;
    
      // Get page effect and label
      if(idx == 12)  // No effect specified
        vScreens[page].effect = "";
      else
        vScreens[page].effect = String.fromCharCode.apply(null, new Uint8Array(buffer, 12, idx - 12));
      
      if(idx == data.length)
        vScreens[page].name = "";
      else
        vScreens[vScreenIndex - 1].name = String.fromCharCode.apply(null, new Uint8Array(buffer, idx + 1));

      // Request page text lines
      ble.read(vBleId, EccbService, CharacteristicText, BleTextChanged, BleError);
    }

    function BlePageChange(page, success, error)
    {
      if(vBleId)
      {
        var d1 = new ArrayBuffer(2);
        var d2 = new Uint8Array(d1);
        d2[0] = 0;
        d2[1] = page;
        
        // Request page change
        ble.write(vBleId, EccbService, CharacteristicPage, d1, success, error);
      }
      else if(typeof(error) === 'function')
        error();
    }
        
    function BleTextChanged(buffer)
    {
      var data = new Uint8Array(buffer, 0, 1);
      var text = String.fromCharCode.apply(null, new Uint8Array(buffer, 1));
      
      vScreens[vScreenIndex - 1].lines[data[0]] = text;
      if((data[0] + 1) < 5)
        ble.read(vBleId, EccbService, CharacteristicText, BleTextChanged, BleError);
      else
        ScreenUpdateLocal();
    }

    function BleTextChange(pageidx, lineidx, text, success, error)
    {
      if(vBleId)
      {
        var d1 = String.fromCharCode.apply(null, new Uint8Array([pageidx, lineidx]));
        d1 += text;
        
        var d2 = new ArrayBuffer(d1.length);
        var d3 = new Uint8Array(d2);
        for (var i = 0, strLen = d1.length; i < strLen; i++)
          d3[i] = d1.charCodeAt(i);
        
        // Request text change
        ble.write(vBleId, EccbService, CharacteristicText, d2, success, error);
      }
      else if(typeof(error) === 'function')
        error();
    }
    
    function BlePageConfig(page, success, error = BleError)
    {
      var buf = new ArrayBuffer(12 + vScreens[page].effect + 1 + vScreens[page].name);
      var data = new Uint8Array(buf);
      var t, len;
      
      data[0] = 0x30;
      data[1] = page;
      t = vScreens[page].duration;
      data[2] = t % 256; t /= 256;
      data[3] = t % 256; t /= 256;
      t = vScreens[page].refresh;
      data[4] = t % 256; t /= 256;
      data[5] = t % 256; t /= 256;
      t = vScreens[page].alarm;
      data[6] = t % 256; t /= 256;
      data[7] = t % 256; t /= 256;
      data[8] = t % 256; t /= 256;
      data[9] = t % 256; t /= 256;
      data[10] = vScreens[page].goto;
      data[11] = 0; // rsvd
      len = 12;

      for (var t = 0; t < vScreens[i].effect.length; t++)
        data[len++] = vScreens[i].effect.charCodeAt(t);
        
      data[len++] = 0;

      for (var t = 0; t < vScreens[i].name.length; t++)
        data[len++] = vScreens[i].name.charCodeAt(t);

      // Send page configuration
      if(vBleId)
        ble.write(vBleId, EccbService, CharacteristicPage, buf, success, error);
      else
        error();
    }
        
    function BleError(error)
    {
      var txt = JSON.stringify(error);
      $('#ble-id').text("ERROR " + txt);
      app.setStatus("BLE ERROR " + txt);
    }
    
    $('#BluetoothConnectPopup').on('popupbeforeposition', function(event, ui)
    {
      console.log('BLE Scan');
      $('#BluetoothConnectButton').addClass('ui-state-disabled');

      $('#hardware').text("?");
      $('#serial').text("?");
      $('#bootloader').text("?");
      $('#firmware').text("?");
      $('#fpgaware').text("?");
      
      if(typeof(ble) !== 'undefined')
      {
        ble.startScan([], function(device)
        {
          if(device.id.slice(0, 11) === "03:80:E1:00")
          {
            $('#ble-id').text(device.name + " (" + device.id + ")");
            vBleId = device.id;
            vBleName = device.name;
            $('#BluetoothConnectButton').removeClass('ui-state-disabled');
          }
        }, 
        BleError);
      }
    });
    
    BluetoothConnectAbort = function()
    {
      console.log('BluetoothConnectAbort');
      if(typeof(ble) !== 'undefined')
      {
        ble.stopScan();
      }
    }
    
    BluetoothConnectExec = function()
    {
      console.log('BluetoothConnectExec');
  
     // if(typeof(ble) !== 'undefined')
      {
        ble.stopScan();

        $('#ble-id').text("Connecting to " + vBleName);

        ble.connect(vBleId, function()
        {
          // Close the popup
          $('#BluetoothConnectPopup').popup('close');

          // Issue read to get current status from device
          ble.read(vBleId, EccbService, CharDeviceInfo, BleDeviceInfo, BleError);
          
          // Issue read to get current status from device
          ble.read(vBleId, EccbService, CharPageChange, BlePageNotified, BleError);
        
          // Subscribe to page-change notifications
          ble.startNotification(vBleId, EccbService, CharPageChange, BlePageNotified, BleError);
          
          // Send time and date to device
          var d1 = new ArrayBuffer(5);
          var d2 = new Uint8Array(d1);
          d2[0] = 0x20;
          var time = Date.now() / 1000 | 0;
          d2[1] = time % 256; time / 256;
          d2[2] = time % 256; time / 256;
          d2[3] = time % 256; time / 256;
          d2[4] = time % 256; time / 256;
          ble.write(vBleId, EccbService, CharacteristicPage, d1, function(){}, BleError);
        },
        BleError);
      }
    }
    
    BluetoothSave = function()
    {
      if(vBleId)
      {
        var d1 = new ArrayBuffer(1);
        var d2 = new Uint8Array(d1);
        d2[0] = 0x11;
        
        // Request save data
        ble.write(vBleId, EccbService, CharacteristicPage, d1, function(){}, BleError);
      }
    }

    BluetoothRefresh = function()
    {
      if(vBleId)
      {
        var d1 = new ArrayBuffer(1);
        var d2 = new Uint8Array(d1);
        d2[0] = 0x10;
        
        // Request save data
        ble.write(vBleId, EccbService, CharacteristicPage, d1, function(){}, BleError);
      }
    }
  </script>

  <div data-role="popup" id="SystemInfoPopup" data-theme="a" data-position-to="window" data-transition="pop" data-dismissible='false' class="ui-corner-all">
    <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>
    <div role="main" class="ui-content">
      <h3>System information</h3>
      <p>Display configuration: <span id="DisplaySize">?x?</span> chars</p>
      <p>Display controller;</p>
      <ul>
        <li>hardware model: <span id='hardware'>?</span></li>
        <li>serial no: <span id='serial'>?</span></li>
        <li>bootloader: <span id='bootloader'>?</span></li>
        <li>software version: <span id='firmware'>?</span></li>
        <li>FPGA version: <span id='fpgaware'>?</span></li>
      </ul>
      <p>App version: <span id='appversion'>0</span></p>
    </div>
  </div>
  <script>
    $('#SystemInfoPopup').on('popupbeforeposition', function(event, ui)
    {
      try
      {
        cordova.getAppVersion.getVersionNumber(function(version)
        {
          //app.setStatus("cordova.getAppVersion.getVersionNumber " + version);
          $('#appversion').text(version);
        });
      }
      catch(e)
      {
        if(typeof(AppVersion) != 'undefined')
          $('#appversion').text(AppVersion.version);
      }
    });
  </script>

</div><!-- /header -->


<div data-role="page" id="splash" data-title="SPLASH" data-next="#content" class="ui-page-theme-a">
  <div id="image" style="height:100%; text-align: center;">
    <img class="vertical" src="images\Etulipa_logo.png" style="object-fit:contain; height:100%; width:100%;" />
    <img class="horizontal" src="images\Etulipa_logo.png" style="object-fit:contain; height:100%; width:100%;" />
  </div>

  <script>
    splashHide = function(event)
    {
      if($("body").pagecontainer("getActivePage").attr('id') == "splash")
      {
        if(event)
          event.stopPropagation();
        if(vSplashTimer)
          clearTimeout(vSplashTimer);
        $("body").pagecontainer("change", next, {reverse: true});
      }
    }
    
    $(document).ready(function()
    {
      splashSizes = function()
      {
        $(header).hide();
        $(header).toolbar('disable');
        $(splash).css('height', window.screen.height);
        $(splash).css('width', window.screen.width);
        $(splash).css('padding-top', '0px');
      }
    
      splashSizes();
      document.getElementById("splash").addEventListener("click", splashHide, true);
      vSplashTimer = setTimeout(splashHide, 5000);
      
      $(document).on("pagecontainerchange", function(event, ui)
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "splash")
          splashSizes();
      });

      $(window).on("orientationchange", function()
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "splash")
          splashSizes();
      });

      $(document).on("pagecontainerbeforechange", function(event, ui)
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "splash")
        {
          $(header).toolbar('enable');
          $(header).show();
        }
      });
    });
  </script>
</div>

<style>
  input.eccb {font-size: 125% !important; font-family: monospace;}
</style>
<div data-role="page" id="content" data-title="ECCB" data-prev="#splash" class="ui-page-theme-a">

  <table style="white-space:nowrap;"><tr>
    <td style="text-align:left;">
      <a id="browsePrv" href="#" class="ui-icon-carat-l ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="ScreenGoto(this);" style="margin-left:8px;">Previous</a>
      <input id="screenIndex" type="button" data-inline="true" data-mini="true" value="1/6" onclick="$('#ScreenArrangePopup').popup('open');">
    </td>
    <td style="text-align:center;"><input id="screenName" type="text" data-inline="true" data-mini="true" readonly value="Screen1"></td>
    <td style="text-align:right;">
      <a id="screenCfg" href="#ScreenConfigPopup" class="ui-icon-clock ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" data-rel="popup" data-position-to="window" data-transition="pop">Config</a>
      <a id="screenRefresh" href="#" class="ui-icon-eye ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="BluetoothRefresh();">Refresh</a>
      <a id="screenUndo" href="#" class="ui-icon-back ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="ScreenReadScreen();">Undo</a>
      <a id="browseFwd" href="#" class="ui-icon-carat-r ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="ScreenGoto(this);">Next</a>
    </td>
  </tr></table>

  <table id="screenText" style="text-align:center;">
    <tr id="line1"><td><input type="text" class="eccb" data-mini="true" value="" onchange="lineUpdate(1);"/></td>
      <td style="width:1%;"><a href="#" class="ui-icon-star ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="lineConfig(1);"></a></td></tr>
    <tr id="line2"><td><input type="text" class="eccb" data-mini="true" value="" onchange="lineUpdate(2);" /></td>
      <td style="width:1%;"><a href="#" class="ui-icon-star ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="lineConfig(2);"></a></td></tr>
    <tr id="line3"><td><input type="text" class="eccb" data-mini="true" value="" onchange="lineUpdate(3);" /></td>
      <td style="width:1%;"><a href="#" class="ui-icon-star ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="lineConfig(3);"></a></td></tr>
    <tr id="line4"><td><input type="text" class="eccb" data-mini="true" value="" onchange="lineUpdate(4);" /></td>
      <td style="width:1%;"><a href="#" class="ui-icon-star ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="lineConfig(4);"></a></td></tr>
    <tr id="line5"><td><input type="text" class="eccb" data-mini="true" value="" onchange="lineUpdate(5);" /></td>
      <td style="width:1%;"><a href="#" class="ui-icon-star ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="lineConfig(5);"></a></td></tr>
  </tr></table>

  <div data-role="footer" data-position="fixed" data-tap-toggle="false">
    <div class="statusMessage">&nbsp;</div>
  </div>

  <div data-role="popup" id="ScreenConfigPopup" data-theme="a" data-transition="pop" data-position-to="window" class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Parameters for this page</h3>
      <table><tr><td>
        <label for="ScreenName">Label</label>
        <input id="ScreenName" type="text" data-mini="true" value="x" />
      </td><td>
        <label for="ScreenDuration">Duration</label>
        <input id="ScreenDuration" type="number" data-mini="true" value="0" />
      </td></tr>
      <tr><td>
        <label for="ScreenEffect">Effect</label>
        <select id="ScreenEffect" data-mini="true" data-native-menu="false"><option value="NONE,">None</option><option value="RADAR,">Radar</option><option value="BUBBLE,">Bubble</option></select>
      </td><td>
        <label for="ScreenRefresh">Refresh</label>
        <input id="ScreenRefresh" type="number" data-mini="true" value="0" />
      </td></tr>
      <tr><td>
        <label for="ScreenAlarm">Alarm</label>
        <input id="ScreenAlarm" type="datetime-local" data-mini="true" value="" />
      </td><td>
        <label for="ScreenGoto">Refresh</label>
        <input id="ScreenGoto" type="number" data-mini="true" value="" />
      </td></tr></table>
      
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancel</a>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow" onclick="ScreenConfigExec();">Done</a>
    </div>
  </div>
  <script>
    $('#ScreenConfigPopup').on('popupbeforeposition', function(event, ui)
    {
      $('#ScreenName').val(vScreens[vScreenIndex - 1].name);
      $('#ScreenEffect').val(vScreens[vScreenIndex - 1].effect).selectmenu('refresh');
      $('#ScreenDuration').val(vScreens[vScreenIndex - 1].duration);
      $('#ScreenRefresh').val(vScreens[vScreenIndex - 1].refresh);
    });
    
    ScreenConfigExec = function()
    {
      vScreens[vScreenIndex - 1].name = $('#ScreenName').val();
      vScreens[vScreenIndex - 1].effect = $('#ScreenEffect').val();
      vScreens[vScreenIndex - 1].duration = $('#ScreenDuration').val();
      vScreens[vScreenIndex - 1].refresh = $('#ScreenRefresh').val(); 
      
      BlePageConfig(vScreenIndex - 1);
      ScreenUpdateLocal();
    }
  </script>

  <div data-role="popup" id="ScreenArrangePopup" data-theme="a" data-transition="pop" data-position-to="window" data-dismissible='false' class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Arrange page</h3>
      <p>TODO Mechanism to rearrange screen to other position</p>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancel</a>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow" onclick="ScreenArrangeExec();">Done</a>
    </div>
  </div>
  <script>
    ScreenArrangeExec = function()
    {
      console.log('ScreenArrangeExec');
    }
  </script>

  <div data-role="popup" id="AddPagePopup" data-theme="a" data-transition="pop" data-position-to="window" data-dismissible='false' class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Add page?</h3>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">No</a>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow" onclick="AddPageExec();">Yes</a>
    </div>
  </div>
  <script>
    AddPageExec = function()
    {
      vScreens[vScreenIndex] = 
      {
        'name':'Page ' + (vScreenIndex + 1),
        'effect': vScreens[vScreenIndex-1].effect,
        'duration': vScreens[vScreenIndex-1].duration,
        'refresh': vScreens[vScreenIndex-1].refresh,
        'goto':0, 'lines':['C,', 'C,', 'C,', 'C,', 'C,']
      };
      vScreenIndex++;
      BlePageConfig(vScreenIndex - 1, function(){}, function(){ScreenUpdateLocal();});
    }
  </script>

  <div data-role="popup" id="LineConfigPopup" data-theme="a" data-transition="pop" data-position-to="window" data-dismissible='false' class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Parameters for text line <span id="no">N</span></h3>
      
      <fieldset data-role="controlgroup" data-type="horizontal" data-mini="true">
        <legend>Text alignment</legend>
        <input type="radio" name="TextAlign" id="TextAlign-L" value="L" />
        <label for="TextAlign-L">Left</label>
        <input type="radio" name="TextAlign" id="TextAlign-C" value="C" />
        <label for="TextAlign-C">Center</label>
        <input type="radio" name="TextAlign" id="TextAlign-R" value="R" />
        <label for="TextAlign-R">Right</label>
      </fieldset>
      
      <select id="TextScroll" data-mini="true" data-native-menu="false"><option value="">Static text</option><option value="SL">Scroll R>L</option><option value="SR,">Scroll L>R</option><option value="TL">Ticker R>L</option><option value="TR">Ticker L>R</option></select>
      
      <fieldset data-role="controlgroup" data-type="horizontal" data-mini="true">
        <label for="TextBold">Bold text</label>
        <input id="TextBold" type="checkbox" data-role="flipswitch" data-on-text="Bold" data-off-text="Normal" data-wrapper-class="custom-size-flipswitch" />

        <label for="ParseDate">Parse date/time</label>
        <input id="ParseDate" type="checkbox" data-role="flipswitch" data-on-text="Parse h:m:s" data-off-text="h:m:s as text" data-wrapper-class="custom-size-flipswitch" />
      </fieldset>

      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancel</a>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow" onclick="LineConfigExec();">Done</a>
    </div>
  </div>
  <script>
    $('#LineConfigPopup').on('popupcreate', function(event, ui)
    {
      $('#TextAlign-L').parent().css('width', '33%');
      $('#TextAlign-C').parent().css('width', '33%');
      $('#TextAlign-R').parent().css('width', '33%');
      $('#TextAlign-L').prev().css('text-align','left');
      $('#TextAlign-C').prev().css('text-align','center');
      $('#TextAlign-R').prev().css('text-align','right');
    });
    
    $('#LineConfigPopup').on('popupbeforeposition', function(event, ui)
    {
      var line = vScreens[vScreenIndex-1].lines[parseInt($('#LineConfigPopup span#no').text())-1].split(",")[0];

      $('#TextAlign-L').prop('checked', false);
      $('#TextAlign-C').prop('checked', false);
      $('#TextAlign-R').prop('checked', false);

      $('#TextScroll').val("");

      $('#TextBold').prop("checked", false);
      $('#ParseDate').prop("checked", false);

      for(var j = 0; j < line.length; j++)
      {
        switch(line[j])
        {
          case 'B': // Bold
            $('#TextBold').prop("checked", true);
          break;

          case 'P': // Parser for date/time
            $('#ParseDate').prop("checked", true);
          break;

          case 'S': // Scroll
            //$('#TextScroll').val(x);
          break;

          case 'T': // Ticker
          break;

          case 'L': // Left aligned
            $('#TextAlign-L').prop('checked', true);
          break;
          case 'C': // Center aligned
            $('#TextAlign-C').prop('checked', true);
          break;
          case 'R': // Right aligned
            $('#TextAlign-R').prop('checked', true);
          break;
          
          case ' ':
          break;
          
          default:
            console.log("LineConfigPopup uncaught '" + line[j] + "'");
          break;
        }
      }
      $('#TextAlign-L').checkboxradio('refresh');
      $('#TextAlign-C').checkboxradio('refresh');
      $('#TextAlign-R').checkboxradio('refresh');
      $('#TextScroll').selectmenu('refresh');
      
      if($('#TextBold').prop('checked'))
        $('#TextBold').parent().addClass('ui-flipswitch-active');
      else
        $('#TextBold').parent().removeClass('ui-flipswitch-active');

      if($('#ParseDate').prop('checked'))
        $('#ParseDate').parent().addClass('ui-flipswitch-active');
      else
        $('#ParseDate').parent().removeClass('ui-flipswitch-active');
    });
    
    LineConfigExec = function()
    {
      var line = parseInt($('#LineConfigPopup span#no').text()) - 1;
      var linecfg = "";
      
      if($('#TextAlign-L').prop('checked'))
        linecfg += "L";
      else if($('#TextAlign-C').prop('checked'))
        linecfg += "C";
      else if($('#TextAlign-R').prop('checked'))
        linecfg += "R";
        
      if(linecfg.length != 0)
      {
        if($('#TextBold').prop('checked'))
          linecfg += "B";
        if($('#ParseDate').prop('checked'))
          linecfg += "P";

        if(linecfg.length != 0)
          linecfg += " ";
    
        linecfg += $('#TextScroll').val();

        linecfg += ","
        if(vScreens[vScreenIndex-1].lines[line].split(",").length > 1)
          linecfg += vScreens[vScreenIndex-1].lines[line].split(",")[1];
      }
      vScreens[vScreenIndex-1].lines[line] = linecfg;
      ScreenUpdateLocal();
      BleTextChange(vScreenIndex-1, line, text);
    }
  </script>
  <script>
    lineConfig = function(no)
    {
      $('#LineConfigPopup span#no').text(no);
      $('#LineConfigPopup').popup('open');
    }
    
    lineUpdate = function(no)
    {
      var text = vScreens[vScreenIndex-1].lines[no-1].split(",")[0];
      if(text.length == 0)
        text += "C";  //  Default feature is center-aligned
      text += "," + $('#screenText tr:nth-child(' + no + ') input').val();
      vScreens[vScreenIndex-1].lines[no-1] = text;
      BleTextChange(vScreenIndex-1, no-1, text);
    }
  </script>

  <script>
    var vScreenIndex = 1;
    
    // Create array of demo screens 
    // L=Left,C=Middle,R=Right,B=Bold,P=Parsers
    // S=Scroll,T=Ticker
    var vScreens = new Array();
    vScreens[0] = {'name':'Intro', 'effect':'RADAR,', 'duration':60, 'refresh':6, 'goto':0, 'lines':['L,intro text 1', 'CBP,intro text 2', 'R,intro text 3', 'C,intro text 4', 'L,intro text 5']};
    vScreens[1] = {'name':'Etulipa', 'effect':'BUBBLE,', 'duration':60, 'refresh':6, 'goto':0, 'lines':['CB,E T U L I P A', 'CT,presents', 'C,', 'CT,Electronic controlled', 'CT,Copyboard']};
    vScreens[2] = {'name':'Page', 'effect':'RADAR,', 'duration':60, 'refresh':6, 'goto':0, 'lines':['', 'L,', 'L,note that the first', 'C,line is preserved', 'R,from previous screen']};
    vScreens[3] = {'name':'Outro', 'effect':'NONE,', 'duration':60, 'refresh':6, 'goto':0, 'lines':['L,outro text 1', 'C,outro text 2', 'R,outro text 3', 'R,outro text 4', 'R,outro text 5']};

    ScreenRefresh = function()
    {
      // Send screen data to display and request play at t=0
    }

    ScreenUpdateLocal = function()
    {
      // Update screen number indicator and label
      $('#screenIndex').val(vScreenIndex + "/" + vScreens.length).button('refresh');
      $('#screenName').val(vScreens[vScreenIndex - 1].name);
      
      // Retrieve screen data from currently selected screen
      for(i = 0; i < vScreens[vScreenIndex - 1].lines.length; i++)
      {
        var line = $('#screenText tr:nth-child(' + (i + 1) + ') input');
        var splits = vScreens[vScreenIndex - 1].lines[i].split(',');
        
        // Set placeholder on line inputbox
        line.attr('placeholder', 'keep previous text');
        line.css('font-weight', '');
        line.css('text-align', 'center');
        
        if(splits.length >= 2)
        {
          splits[0] = splits[0].trim();
          
          // Remove placeholder
          if(splits[0].length != 0)
          {
            line.attr('placeholder', '');
            line.val(splits.slice(1).join(','));
          
            for(var j = 0; j < splits[0].length; j++)
            {
              switch(splits[0][j])
              {
                case 'B': // Bold
                  line.css('font-weight', 'bold');
                break;

                case 'P': // Parser for date/time
                  //$('#ParseDate').prop("checked", true);
                break;

                case 'S': // Scroll
                  //$('#TextScroll').val(x);
                break;

                case 'T': // Ticker
                break;

                case 'L': // Left aligned
                  line.css('text-align', 'left');
                break;
                case 'C': // Center aligned
                  line.css('text-align', 'center');
                break;
                case 'R': // Right aligned
                  line.css('text-align', 'right');
                break;
                
                case ' ':
                break;
                
                default:
                  console.log("ScreenUpdateLocal uncaught '" + splits[0][j] + "'");
                break;
              }
            }
          }
        }
      }
    }

    ScreenGoto = function(_this)
    {
      if(_this.id == 'browsePrv')
      {
        // Select previous screen or ask to insert new screen
        if(vScreenIndex > 1)
          vScreenIndex--;
      }
      else if(_this.id == 'browseFwd')
      {
        // Select next screen or ask to add new screen
        if(vScreenIndex < vScreens.length)
        {
          vScreenIndex++;
        }
        else
        {
          $('#AddPagePopup').popup('open');
          return;
        }
      }
      else
      {
        // Goto screen by reference index
        vScreenIndex = _this;
      }
      BlePageChange(vScreenIndex - 1, function(){}, function(){ScreenUpdateLocal();});
    }

    $(document).ready(function()
    {
      // Register onclick handler for screen parameters
    //  screenparams.onclick = ScreenParamsEdit;
    //  screenconfig.onclick = ScreenParamsExit;
    
      $(document).on("pagecontainerchange", function(event, ui)
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "content")
        {
          vScreenIndex = 1;
          //DisplayReadScreen();
          ScreenUpdateLocal();
        }
      });
    });
  </script>

</div>


<script type="text/javascript">
  app.initialize();
  //app.setStatus("Init");
  $(document).ready(function()
  {
  });
</script>

</body>
</html>
