<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name = "format-detection" content = "telephone=no"/>
  <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
  <link rel="stylesheet" href="css/jquery.mobile-1.4.5.css">
  <link rel="stylesheet" type="text/css" href="css/index.css" />
  <!--script type="text/javascript" src="cordova.js"></script-->
  <script src="js/Tocca.min.js"></script>
  <title>Electronic Copyboard</title>

  <script src="js/jquery.js"></script>

  <script>
    // Bind to "mobileinit" before you load jquery.mobile.js
    $(document).on( "mobileinit", function()
    {
      //$.mobile.defaultPageTransition = "slide";
      $.mobile.listview.prototype.options.headerTheme = "b";
      // Prevent problems with the JQM popups
      $.mobile.popup.prototype.options.history = false;
    });

    pollTimer = 0;
  </script>

  <script src="js/jquery.mobile-1.4.5.js"></script>

  <script>
    $(function()
    {
      $(document).pagecontainer({defaults: true});
      $("[data-role=header]").toolbar(); /* initialize header */

      // Navigate to next page when the "next" button is clicked
      $(".control .next").on("click", function()
      {
        //console.log("nextbtn, "+ prev + " <> " + next);
        if(next)
          $("body").pagecontainer("change", next);
        else
          app.splashshow();
      });
      $(".control .prev").on("click", function()
      {
        console.log("prevbtn, "+ prev + " <> " + next);
        $("body").pagecontainer("change", prev, {reverse: true});
      });
    });

    $(document).on("pagecontainerbeforetransition", function( event, ui )
    {
      // Get the references to the prev and next page that we stored in the data-next attribute
      next = ui.toPage.jqmData("next");
      prev = ui.toPage.jqmData("prev");

      console.log("pagecontainerchange, "+ prev + " <> " + next);
      if(next)
        $(".control .next").removeClass("ui-disabled");
      else
        $(".control .next").addClass("ui-disabled");

      if(prev)
        $(".control .prev").removeClass("ui-disabled");
      else
        $(".control .prev").addClass("ui-disabled");
        
      $("#title").html(ui.toPage.jqmData("title"));
      
      app.setStatus("");
    });

    // Navigate to next page on swipe left
    $(document).on("swipeleft", $(document), function()
    {
      if(next)
      {
        //console.log("swipe, "+ prev + " <> " + next);
        //$("body").pagecontainer("change", next);
      }
    });
    $(document).on("swiperight", $(document), function()
    {
      if(prev)
      {
        //console.log("swipe, "+ prev + " <> " + next);
        //$("body").pagecontainer("change", prev, {reverse: true});
      }
    });

    // Take over the device back button
    $(window).on("navigate", function (event, data)
    {
      var direction = data.state.direction;
      if (direction == 'back')
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "content")
        {
          app.disconnect(true);
          navigator.app.exitApp();	// Android only
        }
        else
        {
          $("body").pagecontainer("change", "#content", {transition:"fade"});
        }
      }
      return(false);
    });

    $.fn.redraw = function()
    {
      return $(this).each(function()
      {
        var redraw = this.offsetHeight;
      });
    };
  </script>

  <script type="text/javascript" src="cordova.js"></script>
  <script type="text/javascript" src="js/index.js"></script>

  <style>
    /* Prevent text selection while swiping with mouse */
    .ui-header, .ui-title, .trivia-btn
    {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      -o-user-select: none;
      user-select: none;
    }
  </style>
</head>
<body style="background-color: #252525;">


<div data-role="header" id="header" style="overflow:hidden;" class="ui-page-theme-a" data-position="fixed" data-tap-toggle="false">
  <h1 id="title">Electronic Copyboard</h1>
  
  <table class="control ui-btn-left"><tr><td>
    <a id="LocalOpen" href="#LocalOpenPopup" class="ui-icon-library ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" data-rel="popup">Load from local</a>
    <a id="LocalSave" href="#LocalSavePopup" class="ui-icon-heart ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" data-rel="popup">Save local</a>
  </td></tr></table>

  <table class="control ui-btn-right"><tr><td>
    <a id="DisplaySave" href="#" class="ui-icon-check ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline ui-state-disabled">Save to display</a>
    <a id="DisplayConnect" href="#BluetoothConnectPopup" class="ui-icon-clock ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" data-rel="popup">Connect to display</a>
    <a id="SysInfo" href="#SystemInfoPopup" class="ui-icon-info ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" data-rel="popup">System info</a>
  </td></tr></table>

  <div data-role="popup" id="LocalSavePopup" data-theme="a" data-position-to="window" data-transition="pop" class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Save display configuration</h3>
      <p>TODO Set filename and dump data to local storage</p>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancel</a>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow" onclick="LocalSaveExec();">Done</a>
    </div>
  </div>
  <script>
    LocalSaveExec = function()
    {
      console.log('Saving');
    }
  </script>

  <div data-role="popup" id="LocalOpenPopup" data-theme="a" data-position-to="window" data-transition="pop" class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Load display configuration</h3>
      <p>TODO List files available in local storage</p>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancel</a>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow" onclick="LocalOpenExec();">Done</a>
    </div>
  </div>
  <script>
    LocalOpenExec = function()
    {
      console.log('Opening');
    }
  </script>

  <div data-role="popup" id="BluetoothConnectPopup" data-theme="a" data-position-to="window" data-transition="pop" class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Bluetooth connect</h3>
      <p>TODO Scan BLE devices in range</p>
      <p><span id="ble-id">***</span></p>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" onclick="BluetoothConnectAbort();">Cancel</a>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow" onclick="BluetoothConnectExec();">Done</a>
    </div>
  </div>
  <script>
    var EccbService = "36a0ca50-bb8f-4ce4-b0a3-6c79a49d533f";
    var CharPageChange = "7223adac-65ff-4c32-b76a-31901df0a818";
    var CharacteristicPage = "0d0a4662-2421-4fbd-90ab-a702ff0239b6";
    var CharacteristicText = "ee5d2e57-3490-4c06-956b-5a384b1cbaa4";
    
    var BleId;

    function BlePageChange(buffer)
    {
      var data = new Uint8Array(buffer);

      // Update page number
      $('#screenIndex').val(data[0] + "/" + data[1]).button('refresh');
      
      // Request full page data
//    $('#screenName').val(vScreens[vScreenIndex - 1].name);//.button('refresh');
      // Request page text lines
    
    }
    
    function BleError(error)
    {
      var msg;

      if(error.error && error.message)
      {
        var errorItems = [];

        if (error.service)
            errorItems.push("service: " + (uuids[error.service] || error.service));

        if (error.characteristic)
            errorItems.push("characteristic: " + (uuids[error.characteristic] || error.characteristic));

        msg = "Error on " + error.error + ": " + error.message + (errorItems.length && (" (" + errorItems.join(", ") + ")"));
      }
      else
      {
        msg = error;
      }
      //log(msg, "error");
        $('#ble-id').text(msg);

      if(error.error === "read" && error.service && error.characteristic)
      {
        //reportValue(error.service, error.characteristic, "Error: " + error.message);
      }
    }
    
    $('#BluetoothConnectPopup').on('popupbeforeposition', function(event, ui)
    {
      console.log('BLE Scan');
      ble.startScan([EccbService], function(status)
      {
        $('#ble-id').text(status.name);
        vBleId = status.id;
      }, 
      BleError);
    });
    
    BluetoothConnectAbort = function()
    {
      console.log('BluetoothConnectAbort');
      ble.stopScan();
    }
    
    BluetoothConnectExec = function()
    {
      console.log('BluetoothConnectExec');
      ble.stopScan();

alert(vBleId);

      ble.connect(vBleId, function(status)
      {
        // close poupup
      
        // Subscribe to page-change notifications
        ble.startNotification(status.id, EccbService, CharPageChange, BlePageChange, BleError);
        
        // Issue read to get current status from device
        ble.read(status.id, EccbService, CharPageChange, BlePageChange, BleError);
      },
      BleError);

    }
  </script>

  <div data-role="popup" id="SystemInfoPopup" data-theme="a" data-position-to="window" data-transition="pop" class="ui-corner-all">
    <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>
    <div role="main" class="ui-content">
      <h3>System information</h3>
      <p>Display configuration: <span>24 x 5 chars</span></p>
      <p>Display controller</p>
      <ul>
        <li>hardware model: <span id='hardware'></span></li>
        <li>serial no: <span id='serial'></span></li>
        <li>FPGA version: <span id='fpgaware'></span></li>
        <li>software version: <span id='firmware'></span></li>
      </ul>
      <p>App version: <span id='versionapp'>0</span></p>
    </div>
  </div>
  <script>
    $('#SystemInfoPopup').on('popupbeforeposition', function(event, ui)
    {
      $('#hardware').text('M077PL016A');
      $('#serial').text('12345678');
      $('#fpgaware').text('0.1');
      $('#firmware').text('0.0.0.0 (1/1/2019)');
      
      try
      {
        cordova.getAppVersion.getVersionNumber(function(version)
        {
          //$('#versionapp').text(version);
          document.getElementById("versionapp").innerText = version;
        });
      }
      catch(e)
      {
        if(typeof(AppVersion) != 'undefined')
          $('#versionapp').text(AppVersion.version);
      }
    });
  </script>

</div><!-- /header -->


<div data-role="page" id="splash" data-title="SPLASH" data-next="#content" class="ui-page-theme-a">
  <div id="image" style="height:100%; text-align: center;">
    <img class="vertical" src="images\Etulipa_logo.png" style="object-fit:contain; height:100%; width:100%;" />
    <img class="horizontal" src="images\Etulipa_logo.png" style="object-fit:contain; height:100%; width:100%;" />
  </div>

  <script>
    splashHide = function(event)
    {
      if($("body").pagecontainer("getActivePage").attr('id') == "splash")
      {
        if(event)
          event.stopPropagation();
        if(vSplashTimer)
          clearTimeout(vSplashTimer);
        $("body").pagecontainer("change", next, {reverse: true});
      }
    }
    
    $(document).ready(function()
    {
      splashSizes = function()
      {
        $(header).hide();
        $(header).toolbar('disable');
        $(splash).css('height', window.screen.height);
        $(splash).css('width', window.screen.width);
        $(splash).css('padding-top', '0px');
      }
    
      splashSizes();
      document.getElementById("splash").addEventListener("click", splashHide, true);
      vSplashTimer = setTimeout(splashHide, 5000);
      
      $(document).on("pagecontainerchange", function(event, ui)
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "splash")
          splashSizes();
      });

      $(window).on("orientationchange", function()
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "splash")
          splashSizes();
      });

      $(document).on("pagecontainerbeforechange", function(event, ui)
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "splash")
        {
          $(header).toolbar('enable');
          $(header).show();
        }
      });
    });
  </script>
</div>

<style>
  input.eccb {font-size: 125% !important; font-family: monospace;}
</style>
<div data-role="page" id="content" data-title="ECCB" data-prev="#bluetooth" data-next="#about" class="ui-page-theme-a">

  <table style="white-space:nowrap;"><tr>
    <td style="text-align:left;">
      <a id="browsePrv" href="#" class="ui-icon-carat-l ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="ScreenGoto(this);" style="margin-left:8px;">Previous</a>
      <input id="screenIndex" type="button" data-inline="true" data-mini="true" value="1/6" onclick="$('#ScreenArrangePopup').popup('open');">
    </td>
    <td style="text-align:center;"><input id="screenName" type="text" data-inline="true" data-mini="true" value="Screen1"></td>
    <td style="text-align:right;">
      <a id="screenCfg" href="#ScreenConfigPopup" class="ui-icon-clock ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" data-rel="popup" data-position-to="window" data-transition="pop">Config</a>
      <a id="screenRefresh" href="#" class="ui-icon-eye ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="ScreenRefresh();">Refresh</a>
      <a id="screenUndo" href="#" class="ui-icon-back ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="ScreenReadScreen();">Undo</a>
      <a id="browseFwd" href="#" class="ui-icon-carat-r ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="ScreenGoto(this);">Next</a>
    </td>
  </tr></table>

  <table id="screenText" style="text-align:center;">
    <tr id="line1"><td><input type="text" class="eccb" data-mini="true" value="" /></td>
      <td style="width:1%;"><a href="#" class="ui-icon-star ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="lineConfig(1);"></a></td></tr>
    <tr id="line2"><td><input type="text" class="eccb" data-mini="true" value="" /></td>
      <td style="width:1%;"><a href="#" class="ui-icon-star ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="lineConfig(2);"></a></td></tr>
    <tr id="line3"><td><input type="text" class="eccb" data-mini="true" value="" /></td>
      <td style="width:1%;"><a href="#" class="ui-icon-star ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="lineConfig(3);"></a></td></tr>
    <tr id="line4"><td><input type="text" class="eccb" data-mini="true" value="" /></td>
      <td style="width:1%;"><a href="#" class="ui-icon-star ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="lineConfig(4);"></a></td></tr>
    <tr id="line5"><td><input type="text" class="eccb" data-mini="true" value="" /></td>
      <td style="width:1%;"><a href="#" class="ui-icon-star ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="lineConfig(5);"></a></td></tr>
  </tr></table>

  <div data-role="popup" id="ScreenConfigPopup" data-theme="a" data-transition="pop" data-position-to="window" class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Parameters for this page</h3>
      <p>TODO Set screen/page duration</p>
      <p>TODO Set transition animation</p>
      <p>TODO Set timetriggered screen/page activation</p>
      <p>TODO Add GOTO mode to jump to non-sequential screen</p>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancel</a>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow" onclick="ScreenConfigExec();">Done</a>
    </div>
  </div>
  <script>
    ScreenConfigExec = function()
    {
      console.log('ScreenConfigExec');
    }
  </script>

  <div data-role="popup" id="ScreenArrangePopup" data-theme="a" data-transition="pop" data-position-to="window" class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Arrange page</h3>
      <p>TODO Mechanism to rearrange screen to other position</p>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancel</a>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow" onclick="ScreenArrangeExec();">Done</a>
    </div>
  </div>
  <script>
    ScreenArrangeExec = function()
    {
      console.log('ScreenArrangeExec');
    }
  </script>

  <div data-role="popup" id="LineConfigPopup" data-theme="a" data-transition="pop" data-position-to="window" class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Parameters for text line <span id="no">N</span></h3>
      <p>TODO Set left/center/right align</p>
      <p>TODO Set bold text mode, set timestamp parse mode</p>
      <p>TODO Set scroll mode left/right clear, ticker</p>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancel</a>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow" onclick="LineConfigExec();">Done</a>
    </div>
  </div>
  <script>
    LineConfigExec = function()
    {
      console.log('LineConfigExec');
    }
  </script>
  <script>
    lineConfig = function(no)
    {
      $('#lineConfig span#no').text(no);
      $('#LineConfigPopup').popup('open');
    }
  </script>

  <script>
    var vScreenIndex = 1;
    
    // Create array of demo screens 
    var vScreens = new Array();
    vScreens[0] = {'name':'Intro', 'duration':60, 'goto':0, 'lines':['intro text 1', 'intro text 2', 'intro text 3', 'intro text 4', 'intro text 5'], 'linecfg':[1, 3, 2, 3, 1]};
    vScreens[1] = {'name':'Etulipa', 'duration':60, 'goto':0, 'lines':['E T U L I P A', 'presents', '', 'Electronic controlled', 'Copyboard'], 'linecfg':[128+3, 3, 3, 3, 3]};
    vScreens[2] = {'name':'Page', 'duration':60, 'goto':0, 'lines':['', '', 'note that the first', 'line is preserved', 'from previous screen'], 'linecfg':[0, 1, 3, 3, 3]};
    vScreens[3] = {'name':'Outro', 'duration':60, 'goto':0, 'lines':['outro text 1', 'outro text 2', 'outro text 3', 'outro text 4', 'outro text 5'], 'linecfg':[1, 2, 3, 2, 1]};

    ScreenRefresh = function()
    {
      // Send screen data to display and request play at t=0
    }

    ScreenUpdateLocal = function()
    {
      // Update screen number indicator and label
      $('#screenIndex').val(vScreenIndex + "/" + vScreens.length).button('refresh');
      $('#screenName').val(vScreens[vScreenIndex - 1].name);//.button('refresh');
      
      // Retrieve screen data from currently selected screen
      for(i = 0; i < 5; i++)
      {
        var line = $('#screenText tr:nth-child(' + (i + 1) + ') input');
        
        if(vScreens[vScreenIndex - 1].linecfg[i] != 0)
        {
          line.val(vScreens[vScreenIndex - 1].lines[i]);
          line.css('font-weight', vScreens[vScreenIndex - 1].linecfg[i] & 128 ? 'bold' : '');
          
          switch(vScreens[vScreenIndex - 1].linecfg[i] % 4)
          {
            case 2:   // Right align
              line.css('text-align', 'right');
              break;
            case 3:   // Center align
              line.css('text-align', 'center');
              break;
            default:
              line.css('text-align', 'left');
              break;
          }
        }
      }
    }

    ScreenGoto = function(_this)
    {
      if(_this.id == 'browsePrv')
      {
        // Select previous screen or ask to insert new screen
        if(vScreenIndex > 1)
          vScreenIndex--;
      }
      else if(_this.id == 'browseFwd')
      {
        // Select next screen or ask to add new screen
        if(vScreenIndex < vScreens.length)
          vScreenIndex++;
      }
      else
      {
        // Goto screen by reference index
        vScreenIndex = _this;
      }
      ScreenUpdateLocal();
    }

    $(document).ready(function()
    {
      // Register onclick handler for screen parameters
    //  screenparams.onclick = ScreenParamsEdit;
    //  screenconfig.onclick = ScreenParamsExit;
    
      $(document).on("pagecontainerchange", function(event, ui)
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "content")
        {
          vScreenIndex = 1;
          //DisplayReadScreen();
          ScreenUpdateLocal();
        }
      });
    });

    mainValue = function(args)
    {
      if(args === undefined)
        var args = ["---", "0"];

      if(lastValue == args)
        return;
      lastValue = args;

      $('.weight').html(args[0]);

      if(indicators)
      {
        args[1] = parseInt(args[1]);

        $('td.ind_red').css('background', args[1] & 0x01 ? "red" : "darkred");
        $('.ind_red').css('color', args[1] & 0x01 ? "red" : "darkred");

        $('td.ind_yellow').css('background', args[1] & 0x02 ? "yellow" : "chocolate");
        $('.ind_yellow').css('color', args[1] & 0x02 ? "yellow" : "chocolate");

        $('td.ind_green').css('background', args[1] & 0x04 ? "lime" : "darkgreen");
        $('.ind_green').css('color', args[1] & 0x04 ? "lime" : "darkgreen");
      }
    }
    lastValue = ["",""];
  </script>

  <script type="text/javascript">
    $(document).ready(function()
    {
//      window.setInterval(function () {app.pollWeight()}, 1000);
    });
  </script>
</div>


<div data-role="page" id="bluetooth" data-title="BLUETOOTH" data-next="#content" class="ui-page-theme-a">
  <fieldset data-role="controlgroup">
    <label for="deviceList">Device:</label>
    <select name="deviceList "id="deviceList">
      <option value="0">...</option>
    </select>
  </fieldset>
  
  <fieldset data-role="controlgroup">
    <a href="#" id="connectButton" data-role="button" class="ui-state-disabled">Connect</a>
    <a href="#" id="disconnectBtn" data-role="button" class="ui-state-disabled">Disconnect</a>
    <a href="#" id="listButton" data-role="button">List Devices</a>
  </fieldset>
  
  <fieldset data-role="controlgroup">
    <a href="#" id="connectQrButton" data-role="button">Connect with QR code</a>
    <a href="#" id="connectQrButton2" data-role="button" onclick="btConnectQR();">Connect with QR code</a>
  </fieldset>

  <div data-role="footer" data-position="fixed" data-tap-toggle="false">
    <div class="statusMessage">&nbsp;</div>
  </div>

  <script type="text/javascript">
    $(document).ready(function()
    {
      $(document).on("pagecontainerchange", function( event, ui )
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "bluetooth")
        {
        /*
          deviceList.innerHTML = "";
          //app.disable(sendBluetooth);

          bluetoothSerial.list(btResults, btFail);
          
          var btFail = function()
          {
            app.setStatus("Bluetooth failure...");
          };
          
          var btResult = function(device)
          {
            var option = $('#deviceList option[value="' + device.address + '"]');
            if(option.length <= 0)
            {
              app.setStatus("Add " + device.name + " (" + device.address + " " + device.class + ")");
              option = document.createElement('option');
              
              if(device.class == 768)
              {
                deviceList.insertBefore(option, deviceList.childNodes[0]);
                if(deviceList.val() === 'undefined')
                  deviceList.val(0);
              }
              else
                deviceList.appendChild(option);
            }
            option.value = device.address;
            option.innerHTML = device.name + " (" + device.address + ")";

            if($('#deviceList').selectmenu('instance') !== undefined)
              $('#deviceList').selectmenu('refresh');
          };
          
          var btResults = function(devices)
          {
            //app.setStatus("Parse results");
            devices.forEach(function(device)
            {
              btResult(device);
            });
          };
          */
        }
      });
    });

    btConnectQR = function()
    {
      cordova.plugins.barcodeScanner.scan(function(result)
      {
        if(!result.cancelled)
          app.connect2("Anonymous via QR", result.text);
      });
    }
  
  </script></div>


<div data-role="page" id="about" data-title="ABOUT" data-prev="#content" data-next="#splash" class="ui-page-theme-a">
  <div id="logo" class="dezaag_logo"><p>Load Monitor</p></div>
  <div>
    <p>LoadMonitor B.V.<br>Postbus 7239<br>3280AA Numansdorp<br>The Netherlands</p>
  </div>
  
  <fieldset data-role="collapsible">
    <h3><span id="versionapp">App version</span></h3>
  </fieldset>

  <fieldset data-role="collapsible">
    <h3><span id="versioncpu">CPU version</span></h3>
    <a href="#" data-role="button" id="updatecpu" class="ui-state-disabled" onclick="FirmwareSend(0, this.path);"><span>...</span></a>
  </fieldset>

  <fieldset data-role="collapsible">
    <h3 class="ui-btn-icon-right ui-icon-star"><span id="versiontft">Display version</span></h3>
    <a href="#" data-role="button" id="updatetft" class="ui-state-disabled" onclick="FirmwareSend(1, this.path);"><span>...</span></a>
  </fieldset>
    
  <div id="version"></div>
  <script type="text/javascript">
    $(document).ready(function()
    {
      //app.enable(update-cpu);

      $(document).on("pagecontainerchange", function(event, ui)
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "about")
        {
          cordova.getAppVersion.getVersionNumber(function (version)
          {
            document.getElementById("versionapp").innerText = "App version " + version;
          });

          function listDir(path)
          {
            window.resolveLocalFileSystemURL(path, function(fileSystem)
            {
              var reader = fileSystem.createReader();
              reader.readEntries(function(entries)
              {
                entries.forEach(function(entry)
                {
                  //document.getElementById("version").innerHTML += "<br>" + entry.name;
                  if(entry.name.indexOf("77-067-103") != -1)
                  {
                    $(updatecpu).children().first().text(entry.name);
                    $(updatecpu).attr('path', entry.fullPath);
                    $(versioncpu).closest('h3').addClass('ui-btn-icon-right ui-icon-star');
                    $(updatecpu).removeClass('ui-state-disabled');
                  }
                  else if(entry.name.indexOf("77-067-107") != -1)
                  {
                    $(updatetft).children().first().text(entry.name);
                    $(updatetft).attr('path', entry.fullPath);
                    $(versiontft).closest('h3').addClass('ui-btn-icon-right ui-icon-star');
                    $(updatetft).removeClass('ui-state-disabled');
                  }
                  //else
                  //console.log(entry);
                });
              }, function (err)
              {
                app.setStatus("Error " + err);
              });
            }, function (err)
            {
              app.setStatus("Error " + err);
            });
          }
          listDir(cordova.file.applicationDirectory + "www/firmware/");
        }
      });
    });
    
    FirmwareSend = function(index, path)
    {
      app.setStatus("Send " + index + "=" + path);
      
      var reader = new FileReader();
      reader.onload = function(event)
      {
        app.setStatus("Read " + reader.result);
      };
      reader.onerror = function(err)
      {
        app.setStatus("Error " + err);
      };
      reader.readAsArrayBuffer(path);
    }
  </script>

  <div data-role="footer" data-position="fixed" data-tap-toggle="false">
    <div class="statusMessage">&nbsp;</div>
  </div>
</div>


<script type="text/javascript">
  app.initialize();
</script>

</body>
</html>
