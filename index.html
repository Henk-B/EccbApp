<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name = "format-detection" content = "telephone=no"/>
  <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
  <link rel="stylesheet" href="css/jquery.mobile-1.4.5.css">
  <link rel="stylesheet" type="text/css" href="css/index.css" />
  <!--script type="text/javascript" src="cordova.js"></script-->
  <script src="js/Tocca.min.js"></script>
  <title>Electronic Copyboard</title>

  <script src="js/jquery.js"></script>

  <script>
    // Bind to "mobileinit" before you load jquery.mobile.js
    $(document).on( "mobileinit", function()
    {
      //$.mobile.defaultPageTransition = "slide";
      $.mobile.listview.prototype.options.headerTheme = "b";
    });

    pollTimer = 0;
  </script>

  <script src="js/jquery.mobile-1.4.5.js"></script>

  <script>
    $(function()
    {
      $(document).pagecontainer({defaults: true});
      $("[data-role=header]").toolbar(); /* initialize header */

      // Navigate to next page when the "next" button is clicked
      $(".control .next").on("click", function()
      {
        //console.log("nextbtn, "+ prev + " <> " + next);
        if(next)
          $("body").pagecontainer("change", next);
        else
          app.splashshow();
      });
      $(".control .prev").on("click", function()
      {
        console.log("prevbtn, "+ prev + " <> " + next);
        $("body").pagecontainer("change", prev, {reverse: true});
      });
    });

    $(document).on("pagecontainerbeforetransition", function( event, ui )
    {
      // Get the references to the prev and next page that we stored in the data-next attribute
      next = ui.toPage.jqmData("next");
      prev = ui.toPage.jqmData("prev");

      console.log("pagecontainerchange, "+ prev + " <> " + next);
      //if(next)
      //  $(".control .next").removeClass("ui-disabled");
      //else
      //  $(".control .next").addClass("ui-disabled");

      if(prev)
        $(".control .prev").removeClass("ui-disabled");
      else
        $(".control .prev").addClass("ui-disabled");
        
      $("#title").html(ui.toPage.jqmData("title"));
      
      app.setStatus("");
    });

    // Navigate to next page on swipe left
    $(document).on("swipeleft", $(document), function()
    {
      if(next)
      {
        //console.log("swipe, "+ prev + " <> " + next);
        //$("body").pagecontainer("change", next);
      }
    });
    $(document).on("swiperight", $(document), function()
    {
      if(prev)
      {
        //console.log("swipe, "+ prev + " <> " + next);
        //$("body").pagecontainer("change", prev, {reverse: true});
      }
    });

    // Take over the device back button
    $(window).on("navigate", function (event, data)
    {
      var direction = data.state.direction;
      if (direction == 'back')
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "content")
        {
          app.disconnect(true);
          navigator.app.exitApp();	// Android only
        }
        else
        {
          $("body").pagecontainer("change", "#content", {transition:"fade"});
        }
      }
      return(false);
    });

    $.fn.redraw = function()
    {
      return $(this).each(function()
      {
        var redraw = this.offsetHeight;
      });
    };
  </script>

  <script type="text/javascript" src="cordova.js"></script>
  <script type="text/javascript" src="js/index.js"></script>

  <style>
    /* Prevent text selection while swiping with mouse */
    .ui-header, .ui-title, .trivia-btn
    {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      -o-user-select: none;
      user-select: none;
    }
  </style>
</head>
<body style="background-color: #252525;">


<div data-role="header" id="header" style="overflow:hidden;" class="ui-page-theme-a" data-position="fixed" data-tap-toggle="false">
  <h1 id="title">Electronic Copyboard</h1>
  
  <table class="control ui-btn-left"><tr><td>
    <a id="LocalOpen" href="#" class="ui-icon-library ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline">Load from local</a>
    <a id="LocalSave" href="#" class="ui-icon-heart ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline ui-state-disabled">Save local</a>
  </td></tr></table>

  <table class="control ui-btn-right"><tr><td>
    <a id="DisplaySave" href="#" class="ui-icon-check ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline ui-state-disabled">Save to display</a>
    <a id="DisplayConnect" href="#" class="ui-icon-recycle ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline">Connect to display</a>
    <a id="SysInfo" href="#" class="ui-icon-info ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline">System info</a>
  </td></tr></table>

</div><!-- /header -->


<div data-role="page" id="splash" data-title="SPLASH" data-next="#content" class="ui-page-theme-a">
  <div id="image" style="height:100%; text-align: center;">
    <img class="vertical" src="images\Etulipa_logo.png" style="object-fit:contain; height:100%; width:100%;" />
    <img class="horizontal" src="images\Etulipa_logo.png" style="object-fit:contain; height:100%; width:100%;" />
  </div>

  <script>
    splashHide = function(event)
    {
      if($("body").pagecontainer("getActivePage").attr('id') == "splash")
      {
        if(event)
          event.stopPropagation();
        if(vSplashTimer)
          clearTimeout(vSplashTimer);
        $("body").pagecontainer("change", next, {reverse: true});
      }
    }
    
    $(document).ready(function()
    {
      splashSizes = function()
      {
        $(header).hide();
        $(header).toolbar('disable');
        $(splash).css('height', window.screen.height);
        $(splash).css('width', window.screen.width);
        $(splash).css('padding-top', '0px');
      }
    
      splashSizes();
      document.getElementById("splash").addEventListener("click", splashHide, true);
      vSplashTimer = setTimeout(splashHide, 5000);
      
      $(document).on("pagecontainerchange", function(event, ui)
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "splash")
          splashSizes();
      });

      $(window).on("orientationchange", function()
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "splash")
          splashSizes();
      });

      $(document).on("pagecontainerbeforechange", function(event, ui)
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "splash")
        {
          $(header).toolbar('enable');
          $(header).show();
        }
      });
    });
  </script>
</div>

<style>
  input.eccb {font-size: 24px; font-family: monospace;}
  screentext div input {float:left;}
  screentext div a {float:right;}
</style>
<div data-role="page" id="content" data-title="CONTENT" data-prev="#bluetooth" data-next="#about" class="ui-page-theme-a">

  <table style="white-space:nowrap;"><tr>
    <td style="text-align:left;"><a id="browsePrv" href="#" class="ui-icon-carat-l ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" style="margin-left:8px;">Previous</a>
      <input id="screenIndex" type="button" data-inline="true" data-mini="true" value="1/6"></td>
    <td style="text-align:center;"><input id="screenName" type="text" data-inline="true" data-mini="true" value="Screen1"></td>
    <td style="text-align:right;"><a id="screenCfg" href="#"  class="ui-icon-clock ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="ScreenConfigEdit();">Config</a>
      <a id="screenRefresh" href="#"  class="ui-icon-eye ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline">Refresh</a>
      <a id="screenUndo" href="#"  class="ui-icon-back ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline">Undo</a>
      <a id="browseFwd" href="#" class="ui-icon-carat-r ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline">Next</a></td>
  </tr></table>

  <div id="screenconfig" class="ui-body ui-corner-all" onclick="ScreenConfigEdit();" style="display:none;">
    editmode
  </div>
  
  <table id="screentext" style="text-align:center;">
    <tr id="line1"><td><input type="text" class="eccb" data-mini="true" value="Sample text" /></td><td style="width:1%;"><a href="#" class="ui-icon-star ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick=""></a></td></tr>
    <tr id="line2"><td><input type="text" class="eccb" data-mini="true" value="Sample text" /></td><td style="width:1%;"><a href="#" class="ui-icon-star ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick=""></a></td></tr>
    <tr id="line3"><td><input type="text" class="eccb" data-mini="true" value="Sample text" /></td><td style="width:1%;"><a href="#" class="ui-icon-star ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick=""></a></td></tr>
    <tr id="line4"><td><input type="text" class="eccb" data-mini="true" value="Sample text" /></td><td style="width:1%;"><a href="#" class="ui-icon-star ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick=""></a></td></tr>
    <tr id="line5"><td><input type="text" class="eccb" data-mini="true" value="Sample text" /></td><td style="width:1%;"><a href="#" class="ui-icon-star ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick=""></a></td></tr>
  </tr></table>

  <script>
    ScreenConfigEdit = function()
    {
      if($('#screenconfig').css('display') == 'none')
      {
        // Hide screen params and screen text, show screenconfig
        $('#screentext').css('display', 'none');
        $('#screenconfig').css('display', '');
      }
      else
      {
        // Show screen params and screen text, hide screenconfig
        $('#screenconfig').css('display', 'none');
        $('#screentext').css('display', '');
      }
    }

    $(document).ready(function()
    {
      
      // Register onclick handler for screen parameters
      screenparams.onclick = ScreenParamsEdit;
      screenconfig.onclick = ScreenParamsExit;
      
      $.fn.textfill = function(options)
      {
        $(weight).parent().css('height', $(weight).parent().css('min-height'));
       
        var fontSize = options.maxFontPixels;
        var ourText = $('#weightdisplay', this);
        var maxHeight = $(weight).height();
        var maxWidth = $(weight).width();
        var textHeight = ourText.outerHeight();
        var textWidth = ourText.outerWidth();

        var tmp = ourText.html();
        if(tmp.length < 6)
        {
          ourText.html('0000KG');
          ourText.redraw();
        }

        ourText.css('font-size', 50);
        ourText.css('marginTop', '');
        ourText.css('display', 'none');

        do
        {
          ourText.css('font-size', fontSize);
          do
          {
            textHeight = ourText.outerHeight();
          }
          while(textHeight == 0);

          textWidth = ourText.outerWidth();
          fontSize -= fontSize / 50;
        }
        while((textHeight > maxHeight || textWidth > maxWidth) && (fontSize > 50));

        //console.log(maxHeight + ", " + textHeight + " - " + maxWidth + ", " + textWidth);
        if(maxHeight - textHeight > 0)
        {
          // adjust vertical position
          ourText.css('marginTop', (maxHeight - textHeight) / 2);
        }
        //ourText.css('backgroundColor', 'red');

        ourText.html(tmp);
        ourText.css('display', 'inline-block');
        return this;
      }

      $(window).on("orientationchange", function()
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "content")
        {
          $('#weightdisplay').css('font-size', 50);
          $('#weightdisplay').css('marginTop', '');
          $('#weightdisplay').css('display', 'none');

          $("div#weight").textfill({ maxFontPixels: 500 });
          //window.setTimeout(function(){$("div#weight").textfill({ maxFontPixels: 500 });}, 150);
        }
      });

      $(document).on("pagecontainerchange", function( event, ui )
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "content")
        {
          $(header).toolbar("updatePagePadding");
          $("div#weight").textfill({ maxFontPixels: 500 });
          //window.setTimeout(function(){$("div#weight").textfill({ maxFontPixels: 500 });}, 150);
        }
      });

    });

    mainValue = function(args)
    {
      if(args === undefined)
        var args = ["---", "0"];

      if(lastValue == args)
        return;
      lastValue = args;

      $('.weight').html(args[0]);

      if(indicators)
      {
        args[1] = parseInt(args[1]);

        $('td.ind_red').css('background', args[1] & 0x01 ? "red" : "darkred");
        $('.ind_red').css('color', args[1] & 0x01 ? "red" : "darkred");

        $('td.ind_yellow').css('background', args[1] & 0x02 ? "yellow" : "chocolate");
        $('.ind_yellow').css('color', args[1] & 0x02 ? "yellow" : "chocolate");

        $('td.ind_green').css('background', args[1] & 0x04 ? "lime" : "darkgreen");
        $('.ind_green').css('color', args[1] & 0x04 ? "lime" : "darkgreen");
      }
    }
    lastValue = ["",""];
  </script>

  <script type="text/javascript">
    $(document).ready(function()
    {
      window.setInterval(function () {app.pollWeight()}, 1000);
    });
  </script>
</div>


<div data-role="page" id="bluetooth" data-title="BLUETOOTH" data-next="#content" class="ui-page-theme-a">
  <fieldset data-role="controlgroup">
    <label for="deviceList">Device:</label>
    <select name="deviceList "id="deviceList">
      <option value="0">...</option>
    </select>
  </fieldset>
  
  <fieldset data-role="controlgroup">
    <a href="#" id="connectButton" data-role="button" class="ui-state-disabled">Connect</a>
    <a href="#" id="disconnectBtn" data-role="button" class="ui-state-disabled">Disconnect</a>
    <a href="#" id="listButton" data-role="button">List Devices</a>
  </fieldset>
  
  <fieldset data-role="controlgroup">
    <a href="#" id="connectQrButton" data-role="button">Connect with QR code</a>
    <a href="#" id="connectQrButton2" data-role="button" onclick="btConnectQR();">Connect with QR code</a>
  </fieldset>

  <div data-role="footer" data-position="fixed" data-tap-toggle="false">
    <div class="statusMessage">&nbsp;</div>
  </div>

  <script type="text/javascript">
    $(document).ready(function()
    {
      $(document).on("pagecontainerchange", function( event, ui )
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "bluetooth")
        {
        /*
          deviceList.innerHTML = "";
          //app.disable(sendBluetooth);

          bluetoothSerial.list(btResults, btFail);
          
          var btFail = function()
          {
            app.setStatus("Bluetooth failure...");
          };
          
          var btResult = function(device)
          {
            var option = $('#deviceList option[value="' + device.address + '"]');
            if(option.length <= 0)
            {
              app.setStatus("Add " + device.name + " (" + device.address + " " + device.class + ")");
              option = document.createElement('option');
              
              if(device.class == 768)
              {
                deviceList.insertBefore(option, deviceList.childNodes[0]);
                if(deviceList.val() === 'undefined')
                  deviceList.val(0);
              }
              else
                deviceList.appendChild(option);
            }
            option.value = device.address;
            option.innerHTML = device.name + " (" + device.address + ")";

            if($('#deviceList').selectmenu('instance') !== undefined)
              $('#deviceList').selectmenu('refresh');
          };
          
          var btResults = function(devices)
          {
            //app.setStatus("Parse results");
            devices.forEach(function(device)
            {
              btResult(device);
            });
          };
          */
        }
      });
    });

    btConnectQR = function()
    {
      cordova.plugins.barcodeScanner.scan(function(result)
      {
        if(!result.cancelled)
          app.connect2("Anonymous via QR", result.text);
      });
    }
  
  </script></div>


<div data-role="page" id="about" data-title="ABOUT" data-prev="#content" data-next="#splash" class="ui-page-theme-a">
  <div id="logo" class="dezaag_logo"><p>Load Monitor</p></div>
  <div>
    <p>LoadMonitor B.V.<br>Postbus 7239<br>3280AA Numansdorp<br>The Netherlands</p>
  </div>
  
  <fieldset data-role="collapsible">
    <h3><span id="versionapp">App version</span></h3>
  </fieldset>

  <fieldset data-role="collapsible">
    <h3><span id="versioncpu">CPU version</span></h3>
    <a href="#" data-role="button" id="updatecpu" class="ui-state-disabled" onclick="FirmwareSend(0, this.path);"><span>...</span></a>
  </fieldset>

  <fieldset data-role="collapsible">
    <h3 class="ui-btn-icon-right ui-icon-star"><span id="versiontft">Display version</span></h3>
    <a href="#" data-role="button" id="updatetft" class="ui-state-disabled" onclick="FirmwareSend(1, this.path);"><span>...</span></a>
  </fieldset>
    
  <div id="version"></div>
  <script type="text/javascript">
    $(document).ready(function()
    {
      //app.enable(update-cpu);

      $(document).on("pagecontainerchange", function(event, ui)
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "about")
        {
          cordova.getAppVersion.getVersionNumber(function (version)
          {
            document.getElementById("versionapp").innerText = "App version " + version;
          });

          function listDir(path)
          {
            window.resolveLocalFileSystemURL(path, function(fileSystem)
            {
              var reader = fileSystem.createReader();
              reader.readEntries(function(entries)
              {
                entries.forEach(function(entry)
                {
                  //document.getElementById("version").innerHTML += "<br>" + entry.name;
                  if(entry.name.indexOf("77-067-103") != -1)
                  {
                    $(updatecpu).children().first().text(entry.name);
                    $(updatecpu).attr('path', entry.fullPath);
                    $(versioncpu).closest('h3').addClass('ui-btn-icon-right ui-icon-star');
                    $(updatecpu).removeClass('ui-state-disabled');
                  }
                  else if(entry.name.indexOf("77-067-107") != -1)
                  {
                    $(updatetft).children().first().text(entry.name);
                    $(updatetft).attr('path', entry.fullPath);
                    $(versiontft).closest('h3').addClass('ui-btn-icon-right ui-icon-star');
                    $(updatetft).removeClass('ui-state-disabled');
                  }
                  //else
                  //console.log(entry);
                });
              }, function (err)
              {
                app.setStatus("Error " + err);
              });
            }, function (err)
            {
              app.setStatus("Error " + err);
            });
          }
          listDir(cordova.file.applicationDirectory + "www/firmware/");
        }
      });
    });
    
    FirmwareSend = function(index, path)
    {
      app.setStatus("Send " + index + "=" + path);
      
      var reader = new FileReader();
      reader.onload = function(event)
      {
        app.setStatus("Read " + reader.result);
      };
      reader.onerror = function(err)
      {
        app.setStatus("Error " + err);
      };
      reader.readAsArrayBuffer(path);
    }
  </script>

  <div data-role="footer" data-position="fixed" data-tap-toggle="false">
    <div class="statusMessage">&nbsp;</div>
  </div>
</div>


<script type="text/javascript">
  app.initialize();
</script>

</body>
</html>
