<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name = "format-detection" content = "telephone=no"/>
  <!--meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" /-->
	<meta name="viewport" content="user-scalable=yes, initial-scale=1, maximum-scale=2, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
	
  <link rel="stylesheet" href="css/jquery.mobile-1.4.5.css">
  <link rel="stylesheet" type="text/css" href="css/index.css" />
  <!--script type="text/javascript" src="cordova.js"></script-->
  <script src="js/Tocca.min.js"></script>
  <title>Electronic Copyboard</title>

  <script src="js/jquery.js"></script>

  <script>
    // Bind to "mobileinit" before you load jquery.mobile.js
    $(document).on( "mobileinit", function()
    {
      //$.mobile.defaultPageTransition = "slide";
      $.mobile.listview.prototype.options.headerTheme = "b";
      // Prevent problems with the JQM popups
      $.mobile.popup.prototype.options.history = false;
    });

    pollTimer = 0;
  </script>

  <script src="js/jquery.mobile-1.4.5.js"></script>

  <script>
    $(function()
    {
      $(document).pagecontainer({defaults: true});
      $("[data-role=header]").toolbar(); /* initialize header */

      // Navigate to next page when the "next" button is clicked
      $(".control .next").on("click", function()
      {
        //console.log("nextbtn, "+ prev + " <> " + next);
        if(next)
          $("body").pagecontainer("change", next);
        else
          app.splashshow();
      });
      $(".control .prev").on("click", function()
      {
        console.log("prevbtn, "+ prev + " <> " + next);
        $("body").pagecontainer("change", prev, {reverse: true});
      });
    });

    $(document).on("pagecontainerbeforetransition", function( event, ui )
    {
      // Get the references to the prev and next page that we stored in the data-next attribute
      next = ui.toPage.jqmData("next");
      prev = ui.toPage.jqmData("prev");

      console.log("pagecontainerchange, "+ prev + " <> " + next);
      if(next)
        $(".control .next").removeClass("ui-disabled");
      else
        $(".control .next").addClass("ui-disabled");

      if(prev)
        $(".control .prev").removeClass("ui-disabled");
      else
        $(".control .prev").addClass("ui-disabled");
        
      $("#title").html(ui.toPage.jqmData("title"));
      
      //app.setStatus("");
    });

    // Navigate to next page on swipe left
    $(document).on("swipeleft", $(document), function()
    {
      if(next)
      {
        //console.log("swipe, "+ prev + " <> " + next);
        //$("body").pagecontainer("change", next);
      }
    });
    $(document).on("swiperight", $(document), function()
    {
      if(prev)
      {
        //console.log("swipe, "+ prev + " <> " + next);
        //$("body").pagecontainer("change", prev, {reverse: true});
      }
    });

    // Take over the device back button
    $(window).on("navigate", function (event, data)
    {
      var direction = data.state.direction;
      if (direction == 'back')
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "content")
        {
          if(vBleId)
          {
            ble.close(vBleId);
            vBleId = "";
          }          
          app.disconnect(true);
          navigator.app.exitApp();	// Android only
        }
        else
        {
          $("body").pagecontainer("change", "#content", {transition:"fade"});
        }
      }
      return(false);
    });

    $.fn.redraw = function()
    {
      return $(this).each(function()
      {
        var redraw = this.offsetHeight;
      });
    };
  </script>

  <script type="text/javascript" src="cordova.js"></script>
  <script type="text/javascript" src="js/index.js"></script>

  <style>
    /* Prevent text selection while swiping with mouse */
    .ui-header, .ui-title, .trivia-btn
    {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      -o-user-select: none;
      user-select: none;
    }
  </style>
</head>
<body style="background-color: #252525;">


<div data-role="header" id="header" style="overflow:hidden;" class="ui-page-theme-a" data-position="fixed" data-tap-toggle="false">
  <h1 id="title">Electronic Copyboard</h1>
  
  <table class="control ui-btn-left"><tr><td>
    <a id="LocalOpen" href="#LocalOpenPopup" class="ui-icon-library ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" data-rel="popup">Load from local</a>
    <a id="LocalSave" href="#LocalSavePopup" class="ui-icon-heart ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" data-rel="popup">Save local</a>
  </td></tr></table>

  <table class="control ui-btn-right"><tr><td>
    <a id="DisplaySave" href="#" class="ui-icon-check ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="BluetoothSave();">Save to display</a>
    <a id="DisplayConnect" href="#BluetoothConnectPopup" class="ui-icon-clock ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" data-rel="popup">Connect to display</a>
    <a id="SysInfo" href="#SystemInfoPopup" class="ui-icon-info ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" data-rel="popup">System info</a>
  </td></tr></table>

  <div data-role="popup" id="LocalSavePopup" data-theme="a" data-position-to="window" data-transition="pop" data-dismissible='false' class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Save display configuration</h3>
      <p>TODO Set filename and dump data to local storage</p>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancel</a>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow" onclick="LocalSaveExec();">Done</a>
    </div>
  </div>
  <script>
    LocalSaveExec = function()
    {
      console.log('Saving');
    }
  </script>

  <div data-role="popup" id="LocalOpenPopup" data-theme="a" data-position-to="window" data-transition="pop" data-dismissible='false' class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Load display configuration</h3>
      <p>TODO List files available in local storage</p>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancel</a>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow" onclick="LocalOpenExec();">Done</a>
    </div>
  </div>
  <script>
    LocalOpenExec = function()
    {
      console.log('Opening');
    }
  </script>

  <div data-role="popup" id="BluetoothConnectPopup" data-theme="a" data-position-to="window" data-transition="pop" data-dismissible='false' class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Bluetooth connect</h3>
      <p>Scanning BLE devices in range</p>
      <p><span id="ble-id">.</span></p>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" onclick="BluetoothConnectAbort();">Cancel</a>
      <a href="#" id="BluetoothConnectButton" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b ui-state-disabled" data-transition="flow" onclick="BluetoothConnectExec();">Connect</a>
    </div>
  </div>
  <div data-role="popup" id="BluetoothDownloadPopup" data-theme="a" data-position-to="window" data-transition="pop" data-dismissible='false' class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Download content from display?</h3>
      <p></p>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" onclick="BluetoothConnectAbort();">No</a>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow" onclick="BluetoothConnectExec();">Yes</a>
    </div>
  </div>
  <script>
    const EccbService = "36a0ca50-bb8f-4ce4-b0a3-6c79a49d533f";
    const CharDeviceInfo = "7223adac-65ff-4c32-b76a-51A02de0b828";
    const CharNotifyCmd = "7223adac-65ff-4c32-b76a-31901df0a818";
    const CharacteristicPage = "0d0a4662-2421-4fbd-90ab-a702ff0239b6";
    const CharacteristicText = "ee5d2e57-3490-4c06-956b-5a384b1cbaa4";
    
    var vBleId, vBleName;
    
    var vScreenIndex;
    var vScreenWidth;
    var vScreenHeight;
    
    function BleDeviceInfo(buffer)
    {
      var text = String.fromCharCode.apply(null, new Uint8Array(buffer));
      text = text.split('\n');
      for(var i = 0; i < text.length; i++)
      {
        var t = text[i].split(' ').slice(1).join(' ');
        
        switch(i)
        {
          case 0: $('#hardware').text(t); break;
          case 1: $('#serial').text(t); break;
          case 2: $('#bootloader').text(t); break;
          case 3: $('#firmware').text(t); break;
          case 4: $('#fpgaware').text(t); break;
        }
      }
    }
    
    function BlePageNotified(buffer)
    {
      var data = new Uint8Array(buffer);
      
      // Request full page data
      if(data.length == 10)
      {
        vScreenIndex = data[0] + 1;  // Update page number
        //vScreenCount = data[1];
        
        // Add missing pages
        for(var i = 0; i < vScreenIndex; i++)
          if(typeof(vScreens[i]) !== 'object')
            vScreens[i] = {'name':'', 'effect':'NONE,10', 'duration':60, 'refresh':6, 'jump':0, 'alarm': new Date(), 'repeat':'', 'interval':9, 'lines':['', '', '', '', '']};

        // Invalidate non existing pages in local data
        while(vScreens.length > data[1])
          vScreens.pop();
        
        //vScreenCountMax = data[2];
        vScreenWidth = (data[7] & 0x7F) * 256 + data[6];
        vScreenHeight = (data[9] & 0x7F) * 256 + data[8];
        $('#DisplaySize').html(vScreenWidth + "&times;" + vScreenHeight)
      }
      ble.read(vBleId, EccbService, CharacteristicPage, BlePageChanged, BleError);
    }
    
    function BlePageChanged(buffer)
    {
      var data = new Uint8Array(buffer);
      var page, idx;

      if(data.length < 10)
        return;
        
      page = data[0];  // Update page number
      vScreens[page].duration = data[3] * 256 + data[1];
      vScreens[page].refresh = data[5] * 256 + data[3];
      
      idx = data[8];
      idx = idx * 256 + data[7];
      idx = idx * 256 + data[6];
      idx = idx * 256 + data[5];
      //parse "2019-10-08T12:33"
      vScreens[page].alarm = new Date();
      vScreens[page].alarm.setMinutes(idx & 0x2F); idx >>= 6;
      vScreens[page].alarm.setHours(idx & 0x1F); idx >>= 5;
      vScreens[page].alarm.setDate(idx & 0x1F + 1); idx >>= 5;
      vScreens[page].alarm.setMonth(idx & 0xF); idx >>= 4;
      vScreens[page].alarm.setFullYear(2010 + (idx & 0x1FF)); idx >>= 9;
      vScreens[page].repeat = data[9];
      vScreens[page].interval = data[10];
      vScreens[page].jump = data[11];
    
      for (idx = 12; idx < data.length; idx++)
        if(data[idx] == 0)
          break;
    
      // Get page effect and label
      if(idx == 12)  // No effect specified
        vScreens[page].effect = "";
      else
        vScreens[page].effect = String.fromCharCode.apply(null, new Uint8Array(buffer, 12, idx - 12));
      
      if(idx == data.length)
        vScreens[page].name = "";
      else
        vScreens[vScreenIndex - 1].name = String.fromCharCode.apply(null, new Uint8Array(buffer, idx + 1));

      // Request page text lines
      ble.read(vBleId, EccbService, CharacteristicText, BleTextChanged, BleError);
    }

    function BlePageChange(page, success, error)
    {
      var d1 = new ArrayBuffer(2);
      var d2 = new Uint8Array(d1);
      d2[0] = 0x00;
      d2[1] = page;

      // Request page change
      if(vBleId)
        ble.write(vBleId, EccbService, CharNotifyCmd, d1, success, function(e){BleError(e); error(e);});
      else
        error();
    }
        
    function BleTextChanged(buffer)
    {
      var data = new Uint8Array(buffer, 0, 1);
      var text = String.fromCharCode.apply(null, new Uint8Array(buffer, 1));
      
      vScreens[vScreenIndex-1].lines[data[0]] = text;

      if((data[0] + 1) < 5)
        ble.read(vBleId, EccbService, CharacteristicText, BleTextChanged, BleError);
      else
        ScreenUpdateLocal();
    }

    function BleTextChange(pageidx, lineidx, text, success, error)
    {
      var d1 = String.fromCharCode.apply(null, new Uint8Array([pageidx, lineidx]));
      d1 += text;

      var d2 = new ArrayBuffer(d1.length);
      var d3 = new Uint8Array(d2);
      for (var i = 0; i < d1.length; i++)
        d3[i] = d1.charCodeAt(i);
        
      // Request text change
      if(vBleId)
        ble.write(vBleId, EccbService, CharacteristicText, d2, success, function(e){BleError(e); error(e);});
      else
        error();
    }
    
    function BlePageConfig(page, success, error)
    {
      var buf = new ArrayBuffer(12 + vScreens[page].effect.length + 1 + vScreens[page].name.length);
      var data = new Uint8Array(buf);
      var t, len;
      
      data[0] = page;
      t = vScreens[page].duration;
      data[1] = t % 256; t /= 256;
      data[2] = t % 256; t /= 256;
      t = vScreens[page].refresh;
      data[3] = t % 256; t /= 256;
      data[4] = t % 256; t /= 256;
      //parse "2019-10-08T12:33" 
      t = vScreens[page].alarm.getDay();
      t = (t << 9) | vScreens[page].alarm.getFullYear() - 2010;
      t = (t << 4) | vScreens[page].alarm.getMonth();
      t = (t << 5) | vScreens[page].alarm.getDate() - 1;
      t = (t << 5) | vScreens[page].alarm.getHours();
      t = (t << 6) | vScreens[page].alarm.getMinutes();
      data[5] = t % 256; t /= 256;
      data[6] = t % 256; t /= 256;
      data[7] = t % 256; t /= 256;
      data[8] = t % 256; t /= 256;
      data[9] = vScreens[page].repeat;
      data[10] = vScreens[page].interval;
      data[11] = vScreens[page].jump;
      len = 12;

      for (t = 0; t < vScreens[page].effect.length; t++)
        data[len++] = vScreens[page].effect.charCodeAt(t);
        
      data[len++] = 0;

      for (t = 0; t < vScreens[page].name.length; t++)
        data[len++] = vScreens[page].name.charCodeAt(t);

      // Send page configuration
      if(vBleId)
        ble.write(vBleId, EccbService, CharacteristicPage, buf, success, function(e){BleError(e); error(e);});
      else
        error();
    }
        
    function BleError(error)
    {
      var txt;
      if(typeof(error) === 'undefined')
        txt = BleError.caller.name;
      else if(typeof(error.errorMessage) !== 'undefined')
        txt = error.errorMessage;
      else if(typeof(error) === 'string')
        txt = error;
      else
        txt = JSON.stringify(error);
        
      $('#ble-id').text("ERROR " + txt);
      app.setStatus("BLE ERROR " + txt);
    }
    
    $('#BluetoothConnectPopup').on('popupbeforeposition', function(event, ui)
    {
      BleStartScan();
    });
    
    BleStartScan = function()
    {
      console.log('BLE Scan');
      $('#BluetoothConnectButton').addClass('ui-state-disabled');

      $('#hardware').text("?");
      $('#serial').text("?");
      $('#bootloader').text("?");
      $('#firmware').text("?");
      $('#fpgaware').text("?");
      
      if(typeof(ble) !== 'undefined')
      {
        ble.startScan([], function(device)
        {
          if(device.id.slice(0, 11) === "03:80:E1:00")
          {
            vBleId = device.id;
            vBleName = device.name;
            $('#ble-id').text(vBleName + " (" +vBleId + ")");
            $('#BluetoothConnectButton').removeClass('ui-state-disabled');
          }
        }, 
        BleError);
      }
    };
    
    BluetoothConnectAbort = function()
    {
      console.log('BluetoothConnectAbort');
      if(typeof(ble) !== 'undefined')
      {
        ble.stopScan();
      }
    }
    
    BluetoothConnectExec = function()
    {
      console.log('BluetoothConnectExec');
      if(typeof(ble) !== 'undefined')
      {
        ble.stopScan();
        $('#ble-id').text("Connecting to " + vBleName);

        ble.connect(vBleId, function()
        {
          // Close the popup
          $('#BluetoothConnectPopup').popup('close');
          $('#ble-id').text("Connected to " + vBleName);

          // Issue read to get current status from device
          ble.read(vBleId, EccbService, CharDeviceInfo, BleDeviceInfo, BleError);
          
          // Issue read to get current status from device
          ble.read(vBleId, EccbService, CharNotifyCmd, BlePageNotified, BleError);
        
          // Subscribe to page-change notifications
          ble.startNotification(vBleId, EccbService, CharNotifyCmd, BlePageNotified, BleError);

          // Send time and date to device
          var d1 = new ArrayBuffer(5);
          var d2 = new Uint8Array(d1);
          d2[0] = 0x20;
          var time = Date.now() / 1000 | 0;
          d2[1] = time % 256; time / 256;
          d2[2] = time % 256; time / 256;
          d2[3] = time % 256; time / 256;
          d2[4] = time % 256; time / 256;
          ble.write(vBleId, EccbService, CharNotifyCmd, d1, function(){}, BleError);
        },
        function(e)
        {
          BleError(e);
          BleStartScan();
        });
      }
    }
    
    BluetoothSave = function()
    {
      if(vBleId)
      {
        var d1 = new ArrayBuffer(1);
        var d2 = new Uint8Array(d1);
        d2[0] = 0x11;
        
        // Request save data
        ble.write(vBleId, EccbService, CharNotifyCmd, d1, function(){}, BleError);
      }
    } 

    BluetoothRefresh = function()
    {
      if(vBleId)
      {
        var d1 = new ArrayBuffer(1);
        var d2 = new Uint8Array(d1);
        d2[0] = 0x10;
        
        // Request playback of page from t=0 and live view of sequence
        ble.write(vBleId, EccbService, CharNotifyCmd, d1, function(){}, BleError);
      }
    }
  </script>

  <div data-role="popup" id="SystemInfoPopup" data-theme="a" data-position-to="window" data-transition="pop" data-dismissible='false' class="ui-corner-all">
    <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>
    <div role="main" class="ui-content">
      <h3>System information</h3>
      <p>Display configuration: <span id="DisplaySize">?x?</span> chars</p>
      <p>Display controller;</p>
      <ul>
        <li>hardware model: <span id='hardware'>?</span></li>
        <li>serial no: <span id='serial'>?</span></li>
        <li>bootloader: <span id='bootloader'>?</span></li>
        <li>software version: <span id='firmware'>?</span></li>
        <li>FPGA version: <span id='fpgaware'>?</span></li>
      </ul>
      <p>App version: <span id='appversion'>0</span></p>
    </div>
  </div>
  <script>
    $('#SystemInfoPopup').on('popupbeforeposition', function(event, ui)
    {
      if(typeof(cordova) !== 'undefined')
      {
        cordova.getAppVersion.getVersionNumber(function(version)
        {
          $('#appversion').text(version);
        });
      }
    });
  </script>

</div><!-- /header -->


<div data-role="page" id="splash" data-title="SPLASH" data-next="#content" class="ui-page-theme-a">
  <div id="image" style="height:100%; text-align: center;">
    <img class="vertical" src="images\Etulipa_logo.png" style="object-fit:contain; height:100%; width:100%;" />
    <img class="horizontal" src="images\Etulipa_logo.png" style="object-fit:contain; height:100%; width:100%;" />
  </div>

  <script>
    splashHide = function(event)
    {
      if($("body").pagecontainer("getActivePage").attr('id') == "splash")
      {
        if(event)
          event.stopPropagation();
        if(vSplashTimer)
          clearTimeout(vSplashTimer);
        $("body").pagecontainer("change", next, {reverse: true});
      }
    }
    
    $(document).ready(function()
    {
      splashSizes = function()
      {
        $(header).hide();
        $(header).toolbar('disable');
        $(splash).css('height', window.screen.height);
        $(splash).css('width', window.screen.width);
        $(splash).css('padding-top', '0px');
      }
    
      splashSizes();
      document.getElementById("splash").addEventListener("click", splashHide, true);
      vSplashTimer = setTimeout(splashHide, 5000);
      
      $(document).on("pagecontainerchange", function(event, ui)
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "splash")
          splashSizes();
      });

      $(window).on("orientationchange", function()
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "splash")
          splashSizes();
      });

      $(document).on("pagecontainerbeforechange", function(event, ui)
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "splash")
        {
          $(header).toolbar('enable');
          $(header).show();
        }
      });
    });
  </script>
</div>

<style>
  input.eccb {font-size: 125% !important; font-family: monospace;}
</style>
<div data-role="page" id="content" data-title="ECCB" data-prev="#splash" class="ui-page-theme-a">

  <table style="white-space:nowrap;"><tr>
    <td style="text-align:left;">
      <a id="browsePrv" href="#" class="ui-icon-carat-l ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="ScreenGoto(this);" style="margin-left:8px;">Previous</a>
      <input id="screenIndex" type="button" data-inline="true" data-mini="true" value="1/6" onclick="$('#ScreenArrangePopup').popup('open');">
    </td>
    <td style="text-align:center;"><input id="screenName" type="text" data-inline="true" data-mini="true" readonly value="Screen1"></td>
    <td style="text-align:right;">
      <a id="screenCfg" href="#ScreenConfigPopup" class="ui-icon-clock ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" data-rel="popup" data-position-to="window" data-transition="pop">Config</a>
      <a id="BluetoothRefresh" href="#" class="ui-icon-eye ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="BluetoothRefresh();">Refresh</a>
      <a id="screenUndo" href="#" class="ui-icon-back ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="ScreenReadScreen();">Undo</a>
      <a id="browseFwd" href="#" class="ui-icon-carat-r ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="ScreenGoto(this);">Next</a>
    </td>
  </tr></table>

  <table id="screenText" style="text-align:center;">
    <tr id="line1"><td><input type="text" class="eccb" data-mini="true" value="" onchange="lineUpdate(1);" /></td>
      <td style="width:1%;"><a href="#" class="ui-icon-star ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="lineConfig(1);"></a></td></tr>
    <tr id="line2"><td><input type="text" class="eccb" data-mini="true" value="" onchange="lineUpdate(2);" /></td>
      <td style="width:1%;"><a href="#" class="ui-icon-star ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="lineConfig(2);"></a></td></tr>
    <tr id="line3"><td><input type="text" class="eccb" data-mini="true" value="" onchange="lineUpdate(3);" /></td>
      <td style="width:1%;"><a href="#" class="ui-icon-star ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="lineConfig(3);"></a></td></tr>
    <tr id="line4"><td><input type="text" class="eccb" data-mini="true" value="" onchange="lineUpdate(4);" /></td>
      <td style="width:1%;"><a href="#" class="ui-icon-star ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="lineConfig(4);"></a></td></tr>
    <tr id="line5"><td><input type="text" class="eccb" data-mini="true" value="" onchange="lineUpdate(5);" /></td>
      <td style="width:1%;"><a href="#" class="ui-icon-star ui-btn ui-shadow ui-corner-all ui-btn-icon-notext ui-nodisc-icon ui-alt-icon ui-btn-a ui-btn-inline" onclick="lineConfig(5);"></a></td></tr>
  </tr></table>

  <div data-role="footer" data-position="fixed" data-tap-toggle="false">
    <div class="statusMessage">&nbsp;</div>
  </div>

  <div data-role="popup" id="ScreenConfigPopup" data-theme="a" data-transition="pop" data-position-to="window" class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Parameters for this page</h3>
      <table><tr><td colspan="2">
        <label for="ScreenName">Label</label>
        <input id="ScreenName" type="text" data-mini="true" value="x" />
      </td><td width="25%">
        <label for="ScreenDuration">Duration</label>
        <input id="ScreenDuration" type="number" data-mini="true" value="0" />
      </td></tr>
      <tr><td width="50%">
        <label for="ScreenEffect">Effect</label>
        <select id="ScreenEffect" data-mini="true" data-native-menu="false"><option value="NONE">None</option><option value="NOISE">Noise</option><option value="RADAR">Radar</option><option value="BUBBLE">Bubble</option><option value="RIPPLE" disabled>Ripple</option><option value="ROLL-H" disabled>Roll (H)</option><option value="ROLL-V" disabled>Roll (V)</option><option value="STRIPE-H" disabled>Stripes (H)</option><option value="STRIPE-V" disabled>Stripes (V)</option><option value="RANDOM">Random</option></select>
      </td><td width="25%">
        <label for="ScreenEffectVal">Speed</label>
        <input id="ScreenEffectVal" type="number" data-mini="true" value="10" />
      </td><td>
        <label for="ScreenRefresh">Refresh</label>
        <input id="ScreenRefresh" type="number" data-mini="true" value="0" />
      </td></tr></table>
      <table><tr><td colspan="2">
      <tr><td colspan="2">
        <label for="ScreenAlarm">Alarm</label>
        <input id="ScreenAlarm" type="datetime-local" data-mini="true" value="" />
      </td><td width="25%">
        <label for="ScreenGoto">Jump to</label>
        <input id="ScreenGoto" type="number" data-mini="true" value="" />
      </td></tr>
      <tr><td width="25%">
        <label for="ScreenInterval">Repeat</label>
        <input id="ScreenInterval" type="number" data-mini="true" value="1" />
      </td><td width="50%">
        <label for="ScreenRepeat">&nbsp;</label>
        <select id="ScreenRepeat" data-mini="true" data-native-menu="false"><option value="0" selected>Alarm OFF</option><option value="1">Once</option><option value="2">Minutes</option><option value="3">Hours</option><option value="4">Days</option><option value="5">Weeks</option><option value="6">Months</option><option value="7">Years</option></select>
      </td><td>
        &nbsp;
      </td></tr></table>
      
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancel</a>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow" onclick="ScreenConfigExec();">Done</a>
    </div>
  </div>
  <script>
    $('#ScreenConfigPopup').on('popupbeforeposition', function(event, ui)
    {
      var effect = vScreens[vScreenIndex - 1].effect.split(',');
      if(effect.length == 1)
        effect[1] = 0;
      
      $('#ScreenName').val(vScreens[vScreenIndex - 1].name);
      $('#ScreenEffect').val(effect[0]).selectmenu('refresh');
      $('#ScreenEffectVal').val(effect[1]);
      $('#ScreenDuration').val(vScreens[vScreenIndex - 1].duration);
      $('#ScreenRefresh').val(vScreens[vScreenIndex - 1].refresh);
      var date = new Date(vScreens[vScreenIndex - 1].alarm);
      date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
      $('#ScreenAlarm').val(date.toISOString().slice(0,16));
      $('#ScreenRepeat').val(vScreens[vScreenIndex - 1].repeat).selectmenu('refresh');
      $('#ScreenInterval').val(vScreens[vScreenIndex - 1].interval);
      $('#ScreenGoto').val(vScreens[vScreenIndex - 1].jump);
    });
    
    ScreenConfigExec = function()
    {
      vScreens[vScreenIndex - 1].name = $('#ScreenName').val();
      vScreens[vScreenIndex - 1].effect = $('#ScreenEffect').val() + "," + $('#ScreenEffectVal').val();
      vScreens[vScreenIndex - 1].duration = parseInt($('#ScreenDuration').val());
      vScreens[vScreenIndex - 1].refresh = parseInt($('#ScreenRefresh').val());
      
      vScreens[vScreenIndex - 1].alarm = new Date($('#ScreenAlarm').val());
      vScreens[vScreenIndex - 1].repeat = parseInt($('#ScreenRepeat').val());
      vScreens[vScreenIndex - 1].interval = parseInt($('#ScreenInterval').val());
      vScreens[vScreenIndex - 1].jump = parseInt($('#ScreenGoto').val());
      
      BlePageConfig(vScreenIndex - 1);
      ScreenUpdateLocal();
    }
  </script>

  <div data-role="popup" id="ScreenArrangePopup" data-theme="a" data-transition="pop" data-position-to="window" data-dismissible='false' class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Arrange page</h3>
      <p>TODO Mechanism to rearrange screen to other position</p>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancel</a>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow" onclick="ScreenArrangeExec();">Done</a>
    </div>
  </div>
  <script>
    ScreenArrangeExec = function()
    {
      console.log('ScreenArrangeExec');
    }
  </script>

  <div data-role="popup" id="AddPagePopup" data-theme="a" data-transition="pop" data-position-to="window" data-dismissible='false' class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Add page?</h3>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">No</a>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow" onclick="AddPageExec();">Yes</a>
    </div>
  </div>
  <script>
    AddPageExec = function()
    {
      vScreens[vScreenIndex] = 
      {
        'name':'Page ' + (vScreenIndex + 1),
        'effect': vScreens[vScreenIndex-1].effect,
        'duration': vScreens[vScreenIndex-1].duration,
        'refresh': vScreens[vScreenIndex-1].refresh,
        'alarm': new Date(), 'repeat': '', 'interval': 0,
        'jump':0, 'lines':['C,', 'C,', 'C,', 'C,', 'C,']
      };
      vScreenIndex++;
      BlePageConfig(vScreenIndex - 1);
      ScreenUpdateLocal();
    }
  </script>

  <div data-role="popup" id="LineConfigPopup" data-theme="a" data-transition="pop" data-position-to="window" data-dismissible='false' class="ui-corner-all">
    <div role="main" class="ui-content">
      <h3>Parameters for text line <span id="no">N</span></h3>
      
      <fieldset data-role="controlgroup" data-type="horizontal" data-mini="true">
        <legend>Text alignment</legend>
        <input type="radio" name="TextAlign" id="TextAlign-L" value="L" onclick="TextAlignCheck(this);" />
        <label for="TextAlign-L">Left</label>
        <input type="radio" name="TextAlign" id="TextAlign-C" value="C" onclick="TextAlignCheck(this);" />
        <label for="TextAlign-C">Center</label>
        <input type="radio" name="TextAlign" id="TextAlign-R" value="R" onclick="TextAlignCheck(this);" />
        <label for="TextAlign-R">Right</label>
      </fieldset>
      
      <table><tr><td>
        <label for="TextScroll">Animation</label>
        <select id="TextScroll" data-mini="true" data-native-menu="false"><option value="KEEP">Keep previous text</option><option value="" selected>Static text</option><option value="SLC">Scroll R>L</option><option value="SRC,">Scroll L>R</option><option value="STLC">Ticker R>L</option><option value="STRC">Ticker L>R</option><option value="SL">Scroll R>L (no clear)</option><option value="SR,">Scroll L>R (no clear)</option><option value="STL">Ticker R>L (no clear)</option><option value="STR">Ticker L>R (no clear)</option></select>
      </td><td width="25%">
        <label for="ScrollSpeed">Speed</label>
        <input id="ScrollSpeed" type="number" data-mini="true" value="100" />
      </td></tr></table>
      
      <fieldset data-role="controlgroup" data-type="horizontal" data-mini="true">
        <label for="TextBold">Bold text</label>
        <input id="TextBold" type="checkbox" data-role="flipswitch" data-on-text="Bold" data-off-text="Normal" data-wrapper-class="custom-size-flipswitch" />

        <label for="ParseDate">Parse date/time</label>
        <input id="ParseDate" type="checkbox" data-role="flipswitch" data-on-text="Parse h:m:s" data-off-text="h:m:s as text" data-wrapper-class="custom-size-flipswitch" />
      </fieldset>

      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancel</a>
      <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow" onclick="LineConfigExec();">Done</a>
    </div>
  </div>
  <script>
    TextAlignCheck = function(_this)
    {
      if($(_this).prev().hasClass('ui-radio-on'))
      {
        $(_this).prop('checked', false);
        $(_this).prev().removeClass('ui-radio-on');
        $(_this).prev().addClass('ui-radio-off');
      }
    }
    
    $('#LineConfigPopup').on('popupcreate', function(event, ui)
    {
      $('#TextAlign-L').parent().css('width', '33%');
      $('#TextAlign-C').parent().css('width', '33%');
      $('#TextAlign-R').parent().css('width', '33%');
      $('#TextAlign-L').prev().css('text-align','left');
      $('#TextAlign-C').prev().css('text-align','center');
      $('#TextAlign-R').prev().css('text-align','right');
    });
    
    $('#LineConfigPopup').on('popupbeforeposition', function(event, ui)
    {
      var splits = vScreens[vScreenIndex-1].lines[parseInt($('#LineConfigPopup span#no').text())-1].split(",");
      var line = splits[0];

      $('#TextAlign-L').prop('checked', false);
      $('#TextAlign-C').prop('checked', false);
      $('#TextAlign-R').prop('checked', false);

      if(line.length == 0)
        $('#TextScroll').val("KEEP");
      else
        $('#TextScroll').val("");

      $('#ScrollSpeed').val("");
      $('#TextBold').prop("checked", false);
      $('#ParseDate').prop("checked", false);

      for(var j = 0; j < line.length; j++)
      {
        var ch = line[j].toUpperCase();
        switch(ch)
        {
          case 'L': // Left aligned
            $('#TextAlign-L').prop('checked', true);
          break;
          case 'C': // Center aligned
            $('#TextAlign-C').prop('checked', true);
          break;
          case 'R': // Right aligned
            $('#TextAlign-R').prop('checked', true);
          break;
          
          case 'B': // Bold
            $('#TextBold').prop("checked", true);
          break;

          case 'T': // Parser for date/time
            $('#ParseDate').prop("checked", true);
          break;

          case 'S': // Scroll
            var opcode = new Array(4);
            opcode[0] = 'S';
            do
            {
              ch = line[++j].toUpperCase();
              switch(ch)
              {
                case 'L': // Roll left
                  opcode[2] = 'L';
                break;
                
                case 'R': // Roll right
                  opcode[2] = 'R';
                break;
                
                case 'T': // Ticker
                  opcode[1] = 'T';
                break;
                
                case 'C': // Start with clear line
                  opcode[3] = 'C';
                break;
              }
            }
            while(/^[A-Z]$/i.test(ch));

            $('#TextScroll').val(opcode.join(''));

            if(/^\d$/.test(ch))
            {
              $('#ScrollSpeed').val(parseInt(line.slice(j)));
              do
              {
                ch = line[++j];
              }
              while(/^\d$/.test(ch));
            }
          break;
          
          case ' ':
          break;

          default:
            console.log("LineConfigPopup uncaught '" + ch + "'");
          break;
        }
      }
      $('#TextAlign-L').checkboxradio('refresh');
      $('#TextAlign-C').checkboxradio('refresh');
      $('#TextAlign-R').checkboxradio('refresh');
      $('#TextScroll').selectmenu('refresh');
      
      if($('#TextBold').prop('checked'))
        $('#TextBold').parent().addClass('ui-flipswitch-active');
      else
        $('#TextBold').parent().removeClass('ui-flipswitch-active');

      if($('#ParseDate').prop('checked'))
        $('#ParseDate').parent().addClass('ui-flipswitch-active');
      else
        $('#ParseDate').parent().removeClass('ui-flipswitch-active');
    });
    
    LineConfigExec = function()
    {
      var line = parseInt($('#LineConfigPopup span#no').text()) - 1;
      var linecfg = "";

      if($('#TextScroll').val() != 'KEEP')
      {
        if($('#TextAlign-L').prop('checked'))
          linecfg += "L";
        else if($('#TextAlign-C').prop('checked'))
          linecfg += "C";
        else if($('#TextAlign-R').prop('checked'))
          linecfg += "R";
      
        if(linecfg.length != 0)
        {
          if($('#TextBold').prop('checked'))
            linecfg += "B";
          if($('#ParseDate').prop('checked'))
            linecfg += "T";

          if(linecfg.length != 0)
            linecfg += " ";
      
          if($('#TextScroll').val() != "")
          {
            linecfg += $('#TextScroll').val();
            linecfg += $('#ScrollSpeed').val();
          }
          linecfg = linecfg.trim();

          linecfg += ","
          if(vScreens[vScreenIndex-1].lines[line].split(",").length > 1)
            linecfg += vScreens[vScreenIndex-1].lines[line].split(",")[1];
        }
      }
      vScreens[vScreenIndex-1].lines[line] = linecfg;
      ScreenUpdateLocal();
      BleTextChange(vScreenIndex-1, line, linecfg);
    }
  </script>
  <script>
    lineConfig = function(no)
    {
      $('#LineConfigPopup span#no').text(no);
      $('#LineConfigPopup').popup('open');
    }
    
    lineUpdate = function(no)
    {
      var textline = $('#screenText tr:nth-child(' + no + ') input').val();
      var textcfg = vScreens[vScreenIndex-1].lines[no-1].split(",")[0];
      
      if((textcfg.length == 0) && (textline.length != 0))
        textcfg += "C";  //  Default feature is center-aligned
      textcfg += "," + textline;
      vScreens[vScreenIndex-1].lines[no-1] = textcfg;
      BleTextChange(vScreenIndex-1, no-1, textcfg);
    }
  </script>

  <script>
    var vScreenIndex = 1;
    
    // Create array of demo screens 
    // L=Left,C=Middle,R=Right,B=Bold,P=Parsers
    // S=Scroll,T=Ticker
    var vScreens = new Array();
    vScreens[0] = {'name':'Intro', 'effect':'RADAR,10', 'lines':['L,intro text 1', 'CBT,intro text 2', 'R,intro text 3', 'C,intro text 4', 'L,intro text 5']};
    vScreens[1] = {'name':'Etulipa', 'effect':'BUBBLE,10', 'lines':['CB,E T U L I P A', 'CT SLTC12,presents', 'C,', 'CT,Electronic controlled', 'CT,Copyboard']};
    vScreens[2] = {'name':'Page', 'effect':'NOISE,10', 'lines':['', 'L,', 'L,note that the first', 'C,line is preserved', 'R,from previous screen']};
    vScreens[3] = {'name':'Outro', 'effect':'RANDOM,10', 'lines':['L,outro text 1', 'C,outro text 2', 'R,outro text 3', 'R,outro text 4', 'R,outro text 5']};

    vScreens[4] = {'name':'Outro', 'effect':'RANDOM,10', 'lines':['SLCT5,TICKER WITH TEXT EXCEEDING THE AVAILABLE WIDTH', 'L SLC5,END LEFT <', 'R SRC5,> END RIGHT', '', '']};

    for (var i in vScreens)
    {
      if(typeof(vScreens[i].alarm) === 'undefined')
        vScreens[i].alarm = new Date();
      if(typeof(vScreens[i].repeat) === 'undefined')
        vScreens[i].repeat = '';
      if(typeof(vScreens[i].interval) === 'undefined')
        vScreens[i].interval = 0;

      if(typeof(vScreens[i].duration) === 'undefined')
        vScreens[i].duration = 60;
      if(typeof(vScreens[i].refresh) === 'undefined')
        vScreens[i].refresh = 10;
    }
    
    ScreenUpdateLocal = function()
    {
      // Update screen number indicator and label
      $('#screenIndex').val(vScreenIndex + "/" + vScreens.length).button('refresh');
      $('#screenName').val(vScreens[vScreenIndex - 1].name);
      
      // Retrieve screen data from currently selected screen
      for(i = 0; i < vScreens[vScreenIndex - 1].lines.length; i++)
      {
        var line = $('#screenText tr:nth-child(' + (i + 1) + ') input');
        var splits = vScreens[vScreenIndex - 1].lines[i].split(',');
        
        // Set placeholder on line inputbox
        line.attr('placeholder', 'keep previous text');
        
        if(splits.length >= 2)
        {
          splits[0] = splits[0].trim();
          
          if(splits[0].length != 0)
          {
            line.css('font-weight', '');
            line.css('text-align', 'center');
            
            line.attr('placeholder', '');
            line.val(splits.slice(1).join(','));
          
            for(var j = 0; j < splits[0].length; j++)
            {
              var ch = splits[0][j].toUpperCase();
              switch(ch)
              {
                case 'L': // Left aligned
                  line.css('text-align', 'left');
                break;
                
                case 'C': // Center aligned
                  line.css('text-align', 'center');
                break;
                
                case 'R': // Right aligned
                  line.css('text-align', 'right');
                break;
                
                case 'B': // Bold
                  line.css('font-weight', 'bold');
                break;

                case 'T': // Parser for date/time
                  //$('#ParseDate').prop("checked", true);
                break;

                case 'S': // Scroll
                {
                  do
                  {
                    ch = splits[0][++j].toUpperCase();
                    switch(ch)
                    {
                      case 'L': // Roll left
                      break;
                      
                      case 'R': // Roll right
                      break;
                      
                      case 'T': // Ticker
                      break;
                      
                      case 'C': // Start with clear line
                      break;
                    }
                  }
                  while(/^[A-Z]$/i.test(ch));

                  //$('#TextScroll').val(opcode.join(''));

                  if(/^\d$/.test(ch))
                  {
                    //$('#ScrollSpeed').val(parseInt(line.slice(j)));
                    do
                    {
                      ch = splits[0][++j];
                    }
                    while(/^\d$/.test(ch));
                  }
                }
                break;

                case ' ':
                break;
                
                default:
                  console.log("ScreenUpdateLocal uncaught '" + ch + "'");
                break;
              }
            }
          }
        }
      }
    }

    ScreenGoto = function(_this)
    {
      if(_this.id == 'browsePrv')
      {
        // Select previous screen or ask to insert new screen
        if(vScreenIndex > 1)
          vScreenIndex--;
      }
      else if(_this.id == 'browseFwd')
      {
        // Select next screen or ask to add new screen
        if(vScreenIndex < vScreens.length)
        {
          vScreenIndex++;
        }
        else
        {
          $('#AddPagePopup').popup('open');
          return;
        }
      }
      else
      {
        // Goto screen by reference index
        vScreenIndex = _this;
      }
      BlePageChange(vScreenIndex - 1, function(){}, function(){ScreenUpdateLocal();});
    }

    $(document).ready(function()
    {
      // Register onclick handler for screen parameters
    //  screenparams.onclick = ScreenParamsEdit;
    //  screenconfig.onclick = ScreenParamsExit;
    
      $(document).on("pagecontainerchange", function(event, ui)
      {
        if($("body").pagecontainer("getActivePage").attr('id') == "content")
        {
          vScreenIndex = 1;
          //DisplayReadScreen();
          ScreenUpdateLocal();
        }
      });
    });
  </script>

</div>


<script type="text/javascript">
  app.initialize();
  //app.setStatus("Init");
  $(document).ready(function()
  {
  });
</script>

</body>
</html>
